<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Excel Value Counter</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Custom scrollbar */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        textarea::-webkit-scrollbar-track { background-color: #f8fafc; }

        /* Smooth transitions */
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }

        /* Drag zone animation */
        @keyframes pulse-border {
            0% { border-color: #6366f1; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { border-color: #4f46e5; box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { border-color: #6366f1; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .drag-active {
            animation: pulse-border 2s infinite;
            background-color: #eef2ff;
            border-color: #4f46e5;
        }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800 py-8 px-4">

    <div class="max-w-5xl mx-auto space-y-6">

        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
                    <i class="ph ph-file-xls text-3xl"></i>
                    Excel Column A Counter
                </h1>
                <p class="text-slate-500 text-sm mt-1">Parses headers and counts substring occurrences in Column A.</p>
            </div>
            <button onclick="window.location.reload()" class="text-sm text-slate-500 hover:text-indigo-600 underline">Reset Tool</button>
        </div>

        <!-- Configuration Section (Collapsible) -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <button id="toggleConfigBtn" class="w-full flex items-center justify-between p-4 bg-slate-50 hover:bg-slate-100 transition-colors text-left">
                <span class="font-semibold text-slate-700 flex items-center gap-2">
                    <i class="ph ph-gear"></i> Configuration: Target Values
                </span>
                <i id="configIcon" class="ph ph-caret-down text-slate-500"></i>
            </button>

            <div id="configPanel" class="p-4 border-t border-slate-200 hidden">
                <div class="flex justify-between items-end mb-2">
                    <label for="targetValuesArea" class="text-sm font-medium text-slate-600">
                        Enter values to search for (one per line):
                    </label>
                    <button onclick="resetDefaultTargets()" class="text-xs text-indigo-600 hover:underline">Restore Defaults</button>
                </div>
                <textarea id="targetValuesArea" rows="10"
                    class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm text-slate-700 bg-slate-50"
                    placeholder="01.01.0010..."></textarea>
                <button id="updateTargets" class="mt-3 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm flex items-center gap-2">
                    <i class="ph ph-check"></i> Save & Update Targets
                </button>
            </div>
        </div>

        <!-- Drag & Drop Zone -->
        <div id="dropArea" class="relative group cursor-pointer">
            <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".xlsx, .xls">
            <div class="w-full h-48 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center bg-white transition-all group-hover:border-indigo-400 group-hover:bg-indigo-50">
                <div class="p-4 rounded-full bg-indigo-50 text-indigo-600 mb-3 group-hover:scale-110 transition-transform">
                    <i class="ph ph-upload-simple text-4xl"></i>
                </div>
                <p class="text-lg font-medium text-slate-700">Drop your <span class="text-indigo-600 font-bold">.xlsx</span> file here</p>
                <p class="text-sm text-slate-400 mt-1">or click to browse</p>
            </div>
        </div>

        <!-- Status Feedback -->
        <div id="feedback" class="hidden rounded-lg p-4 text-center text-sm font-medium"></div>

        <!-- Results Container -->
        <div id="resultsContainer" class="hidden space-y-6">

            <!-- 1. Extracted Headers -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-list-magnifying-glass text-indigo-600"></i> Extracted Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Protokoll (Nr.)</span>
                        <span id="outDatum" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Auftrags-Nr.</span>
                        <span id="outAuftrag" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Anlage (INV_Anlage)</span>
                        <span id="outAnlage" class="block text-lg font-semibold text-slate-800 mt-1 break-all">-</span>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Einsatzort</span>
                        <span id="outOrt" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                    </div>
                </div>
            </div>

            <!-- 2. Count Table -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Target Matches</h2>
                        <p id="matchSummary" class="text-sm text-slate-500">Found 0 matches in 0 rows.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyTableToClipboard()" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 text-slate-600 flex items-center gap-2 transition-colors">
                            <i class="ph ph-copy"></i> Copy
                        </button>
                        <button onclick="downloadCSV()" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 text-slate-600 flex items-center gap-2 transition-colors">
                            <i class="ph ph-download-simple"></i> CSV
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200" id="resultsTable">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Target Value</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Count</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-slate-200">
                            <!-- Rows generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Debug Info -->
            <div id="debugArea" class="hidden p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                <p class="font-bold mb-2"><i class="ph ph-warning-circle"></i> Debugging Info (First 5 values found in Column A):</p>
                <ul id="debugList" class="list-disc list-inside font-mono text-xs"></ul>
                <p class="mt-2 text-xs">If matches are 0, ensure the format above looks like your target list.</p>
            </div>

        </div>
    </div>

    <script>
        // --- Constants & State ---
        const DEFAULT_TARGETS = [
            "01.01.0010", "01.01.0020", "01.01.0030", "01.01.0040", "01.01.0050",
            "01.01.0060", "01.01.0070", "01.01.0080", "01.01.0090", "01.01.0100",
            "01.01.0110", "01.01.0120", "01.01.0130", "01.01.0140", "01.01.0150",
            "01.01.0160", "01.01.0170", "01.01.0180", "01.01.0190", "01.01.0200",
            "01.01.0210", "01.01.0220", "01.01.0230", "01.01.0240", "01.01.0250",
            "01.01.0260", "01.01.0270", "01.01.0280", "01.01.0290", "01.01.0300",
            "01.01.0310", "01.01.0320", "01.01.0330", "01.01.0340", "01.02.0010",
            "01.02.0020", "01.02.0030", "01.02.0040", "01.02.0050", "01.02.0060",
            "01.02.0070", "01.02.0080", "01.03.0010", "01.03.0020", "01.03.0030",
            "01.03.0040", "01.03.0050", "01.03.0060", "01.03.0070", "01.03.0080",
            "01.03.0090", "01.03.0100", "01.03.0110", "01.04.0010", "01.04.0020",
            "01.04.0030", "01.04.0040", "01.04.0050", "01.04.0060", "01.04.0070",
            "01.04.0080", "01.04.0090", "01.05.0010", "01.05.0020", "01.05.0030",
            "01.05.0040", "01.06.0010", "01.06.0020", "01.06.0030", "01.06.0040",
            "01.06.0050"
        ];

        let currentTargets = [];
        let currentResults = []; // For CSV export
        let extractedHeader = {}; // For CSV export

        // --- Elements ---
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const feedback = document.getElementById('feedback');
        const resultsContainer = document.getElementById('resultsContainer');
        const targetValuesArea = document.getElementById('targetValuesArea');
        const updateTargetsBtn = document.getElementById('updateTargets');
        const toggleConfigBtn = document.getElementById('toggleConfigBtn');
        const configPanel = document.getElementById('configPanel');
        const configIcon = document.getElementById('configIcon');

        // --- Initialization ---
        function init() {
            resetDefaultTargets();
            updateTargets(); // Load defaults into memory

            // Listeners
            updateTargetsBtn.addEventListener('click', () => {
                updateTargets();
                showFeedback('Targets updated successfully!', 'success');
            });

            toggleConfigBtn.addEventListener('click', () => {
                configPanel.classList.toggle('hidden');
                configIcon.classList.toggle('ph-caret-up');
                configIcon.classList.toggle('ph-caret-down');
            });

            fileInput.addEventListener('change', handleFileSelect);

            // Drag effects
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    dropArea.querySelector('div').classList.add('drag-active');
                }, false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    dropArea.querySelector('div').classList.remove('drag-active');
                }, false);
            });
            dropArea.addEventListener('drop', handleDrop, false);
        }

        // --- Core Logic ---

        function resetDefaultTargets() {
            targetValuesArea.value = DEFAULT_TARGETS.join('\n');
        }

        function updateTargets() {
            currentTargets = targetValuesArea.value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            if (file) processFile(file);
        }

        function showFeedback(msg, type) {
            feedback.className = `rounded-lg p-4 text-center text-sm font-medium mb-6 ${
                type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' :
                type === 'loading' ? 'bg-blue-50 text-blue-700 border border-blue-200 flex justify-center items-center gap-2' :
                'bg-green-50 text-green-700 border border-green-200'
            }`;

            if(type === 'loading') {
                feedback.innerHTML = `<div class="loader"></div> ${msg}`;
            } else {
                feedback.textContent = msg;
            }
            feedback.classList.remove('hidden');
        }

        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showFeedback('Invalid file type. Please upload an Excel (.xlsx) file.', 'error');
                return;
            }

            showFeedback(`Processing ${file.name}...`, 'loading');
            resultsContainer.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (workbook.SheetNames.length === 0) throw new Error("No sheets found.");
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];

                    // KEY FIX: raw: false ensures we get the formatted string (e.g., "01.01.2020")
                    // instead of the Excel serial number (e.g., 43831).
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });

                    analyzeData(rows);
                } catch (err) {
                    console.error(err);
                    showFeedback(`Error reading file: ${err.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function analyzeData(rows) {
            // 1. Extract Headers
            const datum = findValue(rows, "Nr.:");
            const auftrag = findValue(rows, "Auftrag Nr.:");
            const inv = findValue(rows, "INV:");
            const anlage = findValue(rows, "Anlage:");
            const ort = findOrtValue(rows); // Special logic for 2nd occurrence

            extractedHeader = {
                datum: datum || "Not Found",
                auftrag: auftrag || "Not Found",
                anlage: (inv || anlage) ? `${inv || ''}_${anlage || ''}` : "N/A",
                ort: ort || "Not Found"
            };

            // Update Header UI
            document.getElementById('outDatum').textContent = extractedHeader.datum;
            document.getElementById('outAuftrag').textContent = extractedHeader.auftrag;
            document.getElementById('outAnlage').textContent = extractedHeader.anlage;
            document.getElementById('outOrt').textContent = extractedHeader.ort;

            // 2. Count Occurrences
            const counts = new Map();
            let totalMatches = 0;
            let debugRows = [];

            // Initialize Map with 0 for all targets
            currentTargets.forEach(t => counts.set(t, 0));

            // Iterate Rows
            rows.forEach((row, idx) => {
                // Column A is index 0. Ensure it's a string.
                const cellVal = String(row[0] || "").trim();

                if (!cellVal) return;

                // Debug first 5 rows
                if (debugRows.length < 5) debugRows.push(cellVal);

                // Check against targets
                currentTargets.forEach(target => {
                    if (cellVal.includes(target)) {
                        counts.set(target, counts.get(target) + 1);
                        totalMatches++;
                    }
                });
            });

            // 3. Render Table
            renderTable(counts, totalMatches, rows.length);

            // 4. Show Debug if no matches
            const debugArea = document.getElementById('debugArea');
            if (totalMatches === 0) {
                debugArea.classList.remove('hidden');
                document.getElementById('debugList').innerHTML = debugRows.map(v => `<li>${v}</li>`).join('');
            } else {
                debugArea.classList.add('hidden');
            }

            showFeedback('Analysis complete.', 'success');
            resultsContainer.classList.remove('hidden');
        }

        // --- Helper Functions ---

        // Finds a label (searchStr) and returns the NEXT non-empty cell in that row.
        function findValue(rows, searchStr) {
            for (let r = 0; r < rows.length; r++) {
                const row = rows[r];
                for (let c = 0; c < row.length; c++) {
                    const cell = String(row[c] || "");
                    if (cell.includes(searchStr)) {
                        // Found label, scan rest of row for value
                        for (let k = c + 1; k < row.length; k++) {
                            const val = String(row[k] || "").trim();
                            if (val) return val;
                        }
                    }
                }
            }
            return null;
        }

        // Specific requirement: Find the SECOND occurrence of "Ort:"
        function findOrtValue(rows) {
            let occurrences = 0;
            for (let r = 0; r < rows.length; r++) {
                const row = rows[r];
                for (let c = 0; c < row.length; c++) {
                    const cell = String(row[c] || "");
                    if (cell.includes("Ort:")) {
                        occurrences++;
                        if (occurrences === 2) {
                            // Found 2nd occurrence, scan rest of row
                            for (let k = c + 1; k < row.length; k++) {
                                const val = String(row[k] || "").trim();
                                if (val) return val;
                            }
                        }
                    }
                }
            }
            return null;
        }

        function renderTable(countsMap, totalMatches, rowCount) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            document.getElementById('matchSummary').textContent =
                `Found ${totalMatches} matches across ${rowCount} processed rows.`;

            // Filter only positive counts if you want to hide zeros,
            // OR show all to confirm what was checked.
            // Logic: Show all non-zero, plus sort them.
            const sorted = Array.from(countsMap.entries())
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1]); // Sort by count DESC

            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500 italic">No targets found in Column A</td></tr>`;
                currentResults = [];
                return;
            }

            currentResults = sorted; // Save for CSV

            sorted.forEach(([target, count]) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-indigo-700 font-medium">${target}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-bold">${count}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Found</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- Export Features ---

        function copyTableToClipboard() {
            if (!currentResults.length) return;
            let text = "Target Value\tCount\n";
            currentResults.forEach(r => text += `${r[0]}\t${r[1]}\n`);
            navigator.clipboard.writeText(text).then(() => alert("Table copied to clipboard!"));
        }

        function downloadCSV() {
            if (!currentResults.length) return;

            // Create CSV Content
            // Add Header Info at top
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Protokoll,${extractedHeader.datum}\n`;
            csvContent += `Auftrag,${extractedHeader.auftrag}\n`;
            csvContent += `Anlage,${extractedHeader.anlage}\n`;
            csvContent += `Ort,${extractedHeader.ort}\n\n`;

            // Add Table Data
            csvContent += "Target Value,Count\n";
            currentResults.forEach(row => {
                csvContent += `${row[0]},${row[1]}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `analysis_results_${extractedHeader.auftrag || 'export'}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Run init
        init();
    </script>
</body>
</html>