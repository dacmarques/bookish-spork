<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Excel Tools</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Phosphor Icons (Tool 1) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Lucide Icons (Tool 2) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts (Tool 2) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Shared Styles */
        body { font-family: 'Inter', sans-serif; }

        /* Tool 1 Styles */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        textarea::-webkit-scrollbar-track { background-color: #f8fafc; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        @keyframes pulse-border {
            0% { border-color: #6366f1; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { border-color: #4f46e5; box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { border-color: #6366f1; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .drag-active {
            animation: pulse-border 2s infinite;
            background-color: #eef2ff;
            border-color: #4f46e5;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tool 2 Styles */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dragover {
            background-color: #eff6ff;
            border-color: #3b82f6;
            border-style: solid;
            transform: scale(1.005);
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="font-bold text-xl text-slate-800">Excel Tools Suite</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <button onclick="switchTab('tool1')" id="tab-tool1" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Value Counter
                        </button>
                        <button onclick="switchTab('tool2')" id="tab-tool2" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Smart Extractor
                        </button>
                        <button onclick="switchTab('tool3')" id="tab-tool3" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Row Manager
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-[95%] mx-auto py-6 sm:px-6 lg:px-8">

        <!-- Tool 1: Excel Value Counter -->
        <div id="tool1-content" class="block">

    <div class="max-w-5xl mx-auto space-y-6">

        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
                    <i class="ph ph-file-xls text-3xl"></i>
                    Excel Column A Counter
                </h1>
                <p class="text-slate-500 text-sm mt-1">Parses headers and counts substring occurrences in Column A.</p>
            </div>
            <button onclick="window.location.reload()" class="text-sm text-slate-500 hover:text-indigo-600 underline">Reset Tool</button>
        </div>

        <!-- Configuration Section (Collapsible) -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <button id="toggleConfigBtn" class="w-full flex items-center justify-between p-4 bg-slate-50 hover:bg-slate-100 transition-colors text-left">
                <span class="font-semibold text-slate-700 flex items-center gap-2">
                    <i class="ph ph-gear"></i> Configuration: Target Values
                </span>
                <i id="configIcon" class="ph ph-caret-down text-slate-500"></i>
            </button>

            <div id="configPanel" class="p-4 border-t border-slate-200 hidden">
                <div class="flex justify-between items-end mb-2">
                    <label for="targetValuesArea" class="text-sm font-medium text-slate-600">
                        Enter values to search for (one per line):
                    </label>
                    <button onclick="resetDefaultTargets()" class="text-xs text-indigo-600 hover:underline">Restore Defaults</button>
                </div>
                <textarea id="targetValuesArea" rows="10"
                    class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm text-slate-700 bg-slate-50"
                    placeholder="01.01.0010..."></textarea>
                <button id="updateTargets" class="mt-3 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm flex items-center gap-2">
                    <i class="ph ph-check"></i> Save & Update Targets
                </button>
            </div>
        </div>

        <!-- Drag & Drop Zone -->
        <div id="dropArea" class="relative group cursor-pointer">
            <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".xlsx, .xls">
            <div class="w-full h-48 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center bg-white transition-all group-hover:border-indigo-400 group-hover:bg-indigo-50">
                <div class="p-4 rounded-full bg-indigo-50 text-indigo-600 mb-3 group-hover:scale-110 transition-transform">
                    <i class="ph ph-upload-simple text-4xl"></i>
                </div>
                <p class="text-lg font-medium text-slate-700">Drop your <span class="text-indigo-600 font-bold">.xlsx</span> file here</p>
                <p class="text-sm text-slate-400 mt-1">or click to browse</p>
            </div>
        </div>

        <!-- Status Feedback -->
        <div id="feedback" class="hidden rounded-lg p-4 text-center text-sm font-medium"></div>

        <!-- Results Container -->
        <div id="resultsContainer" class="hidden space-y-6">

            <!-- 1. Extracted Headers -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-list-magnifying-glass text-indigo-600"></i> Extracted Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Protokoll (Nr.)</span>
                        <span id="outDatum" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                        <button onclick="copyToClipboard('outDatum')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Auftrags-Nr.</span>
                        <span id="outAuftrag" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                        <button onclick="copyToClipboard('outAuftrag')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Anlage (INV_Anlage)</span>
                        <span id="outAnlage" class="block text-lg font-semibold text-slate-800 mt-1 break-all">-</span>
                        <button onclick="copyToClipboard('outAnlage')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Einsatzort</span>
                        <span id="outOrt" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                        <button onclick="copyToClipboard('outOrt')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Count Table -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Target Matches</h2>
                        <p id="matchSummary" class="text-sm text-slate-500">Found 0 matches in 0 rows.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyTableToClipboard()" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 text-slate-600 flex items-center gap-2 transition-colors">
                            <i class="ph ph-copy"></i> Copy
                        </button>
                        <button onclick="downloadCSV()" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 text-slate-600 flex items-center gap-2 transition-colors">
                            <i class="ph ph-download-simple"></i> CSV
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200" id="resultsTable">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 select-none" onclick="handleSort('target')">
                                    <div class="flex items-center gap-1">
                                        Target Value
                                        <i id="sort-icon-target" class="ph ph-arrows-down-up text-slate-400"></i>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 select-none" onclick="handleSort('count')">
                                    <div class="flex items-center gap-1">
                                        Count
                                        <i id="sort-icon-count" class="ph ph-arrow-down text-indigo-600"></i>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-slate-200">
                            <!-- Rows generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Debug Info -->
            <div id="debugArea" class="hidden p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                <p class="font-bold mb-2"><i class="ph ph-warning-circle"></i> Debugging Info (First 5 values found in Column A):</p>
                <ul id="debugList" class="list-disc list-inside font-mono text-xs"></ul>
                <p class="mt-2 text-xs">If matches are 0, ensure the format above looks like your target list.</p>
            </div>

        </div>
    </div>
        </div>

        <!-- Tool 2: Smart Excel Extractor -->
        <div id="tool2-content" class="hidden">

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">

        <!-- Upload Section -->
        <div class="mb-8">
            <div id="drop-area" class="group relative w-full h-48 border-2 border-dashed border-slate-300 rounded-2xl bg-white flex flex-col items-center justify-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:shadow-md">
                <div class="pointer-events-none flex flex-col items-center text-center space-y-3">
                    <div class="p-3 bg-slate-100 rounded-full group-hover:bg-blue-100 text-slate-400 group-hover:text-blue-600 transition-colors duration-300">
                        <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-slate-700 group-hover:text-blue-700 transition-colors">Excel-Dateien hier ablegen</p>
                        <p class="text-sm text-slate-400 mt-1">Unterstützt .xlsx Dateien</p>
                    </div>
                </div>
                <input type="file" id="fileElem" multiple accept=".xlsx" class="hidden" onchange="handleFiles(this.files)">
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-4 gap-4">
            <div class="flex items-center gap-4 flex-wrap">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <div class="bg-emerald-100 p-1.5 rounded text-emerald-700">
                        <i data-lucide="table-2" class="w-4 h-4"></i>
                    </div>
                    Extrahierte Daten
                    <span id="record-count-badge" class="text-xs font-normal bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full hidden">0</span>
                </h2>
                <!-- Filter Input -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
                    </div>
                    <input type="text" id="filter-input-extractor" placeholder="Filtern..."
                        class="pl-9 pr-4 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-slate-700 shadow-sm w-48">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="exportToExcel()" id="btn-export" class="opacity-50 cursor-not-allowed px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-sm shadow-green-200 transition-all flex items-center gap-2" disabled>
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Exportieren (.xlsx)
                </button>
                <button onclick="clearTable()" class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg border border-red-200 transition-colors flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Leeren
                </button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
            <div class="overflow-x-auto custom-scrollbar">
                <table id="data-table" class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200 sticky top-0">
                        <tr>
                            <th class="px-6 py-4 font-semibold whitespace-nowrap cursor-pointer hover:bg-slate-100 select-none group" onclick="handleExtractorSort('fileName')">
                                <div class="flex items-center gap-1">Datei <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-fileName"></i></div>
                            </th>
                            <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 select-none group" onclick="handleExtractorSort('auftragsNr')">
                                <div class="flex items-center gap-1">Auftrags-Nr. <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-auftragsNr"></i></div>
                            </th>
                            <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 select-none group" onclick="handleExtractorSort('anlage')">
                                <div class="flex items-center gap-1">Anlage <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-anlage"></i></div>
                            </th>
                            <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 select-none group" onclick="handleExtractorSort('einsatzort')">
                                <div class="flex items-center gap-1">Einsatzort <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-einsatzort"></i></div>
                            </th>
                            <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 select-none group" onclick="handleExtractorSort('datum')">
                                <div class="flex items-center gap-1">Datum <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-datum"></i></div>
                            </th>
                            <th class="px-6 py-4 font-semibold cursor-pointer hover:bg-slate-100 select-none group" title="Fachmonteurstunde" onclick="handleExtractorSort('fachmonteur')">
                                <div class="flex items-center gap-1">
                                    Fach. (M)
                                    <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-fachmonteur"></i>
                                </div>
                                <span class="block text-[10px] normal-case opacity-70 font-normal">Links v. Label</span>
                            </th>
                            <th class="px-6 py-4 font-semibold text-right cursor-pointer hover:bg-slate-100 select-none group" onclick="handleExtractorSort('sumRaw')">
                                <div class="flex items-center justify-end gap-1">Auftragssumme <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-sumRaw"></i></div>
                            </th>
                            <th class="px-6 py-4 font-semibold min-w-[250px] cursor-pointer hover:bg-slate-100 select-none group" onclick="handleExtractorSort('bemerkung')">
                                <div class="flex items-center gap-1">
                                    Bemerkung
                                    <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity sort-icon" id="sort-bemerkung"></i>
                                </div>
                                <span class="block text-[10px] normal-case opacity-70 font-normal">Unter d. Label</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        <!-- Rows inserted via JS -->
                        <tr id="empty-state">
                            <td colspan="8" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center justify-center text-slate-300">
                                    <i data-lucide="search-x" class="w-12 h-12 mb-3 opacity-50"></i>
                                    <span class="text-base font-medium">Keine Daten vorhanden</span>
                                    <span class="text-sm">Dateien oben in den Bereich ziehen</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer / Totals -->
            <div class="bg-slate-50 border-t border-slate-200 p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-xs text-slate-500">
                        Erfolgreich verarbeitet: <span id="count-display" class="font-bold text-slate-800">0</span> Dateien
                    </div>

                    <div class="flex items-center bg-white px-5 py-3 rounded-xl border border-slate-200 shadow-sm gap-4">
                        <div class="text-right">
                            <p class="text-[10px] uppercase font-bold tracking-wider text-slate-400 mb-0.5">Gesamtsumme</p>
                            <h3 class="text-2xl font-bold text-slate-800 tabular-nums" id="total-display">0,00 €</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i data-lucide="euro" class="w-5 h-5"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
        </div>

        <!-- Tool 3: Row Manager -->
        <div id="tool3-content" class="hidden">
            <div class="space-y-6">

                <!-- Header -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
                            <i class="ph ph-rows text-3xl"></i> Row Manager
                        </h1>
                        <p class="text-slate-500 text-sm mt-1">Upload an Excel file, drag to reorder rows, and copy data for pasting back into Excel.</p>
                    </div>
                </div>

                <!-- Upload Zone -->
                <div id="rm-drop-area" class="relative group cursor-pointer">
                    <input type="file" id="rm-file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".xlsx, .xls">
                    <div class="w-full h-32 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center bg-white transition-all group-hover:border-indigo-400 group-hover:bg-indigo-50">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full bg-indigo-50 text-indigo-600">
                                <i class="ph ph-upload-simple text-2xl"></i>
                            </div>
                            <div class="text-center">
                                <p class="text-base font-medium text-slate-700">Drop <span class="text-indigo-600 font-bold">.xlsx</span> file here</p>
                                <p class="text-xs text-slate-400">or click to browse</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div id="rm-results" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[75vh]">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 shrink-0">
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-slate-700 flex items-center gap-2">
                                <i class="ph ph-table"></i>
                                <span id="rm-status">0 Rows</span>
                            </span>
                            <span class="text-xs text-slate-400">Drag rows to reorder.</span>
                        </div>
                        <button onclick="window.rmClear()" class="px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg border border-red-200 transition-colors flex items-center gap-2">
                            <i class="ph ph-trash"></i> Clear
                        </button>
                    </div>

                    <div class="overflow-auto flex-grow custom-scrollbar relative">
                        <table class="min-w-full divide-y divide-slate-200 text-sm relative border-collapse">
                            <thead class="bg-slate-100 sticky top-0 z-20 shadow-sm ring-1 ring-slate-200">
                                <tr id="rm-thead-tr">
                                    <!-- Headers generated here -->
                                </tr>
                            </thead>
                            <tbody id="rm-tbody" class="bg-white divide-y divide-slate-100">
                                <!-- Rows generated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Notification Area (Shared) -->
    <div id="notification-area" class="fixed bottom-6 right-6 space-y-3 pointer-events-none z-50 flex flex-col items-end"></div>

    <script>
        // Tab Switching Logic
        function switchTab(tabName) {
            const contents = {
                'tool1': document.getElementById('tool1-content'),
                'tool2': document.getElementById('tool2-content'),
                'tool3': document.getElementById('tool3-content')
            };
            const tabs = {
                'tool1': document.getElementById('tab-tool1'),
                'tool2': document.getElementById('tab-tool2'),
                'tool3': document.getElementById('tab-tool3')
            };

            // Hide all, reset tabs
            Object.keys(contents).forEach(key => {
                contents[key].classList.add('hidden');
                tabs[key].classList.add('border-transparent', 'text-gray-500');
                tabs[key].classList.remove('border-indigo-500', 'text-gray-900');
            });

            // Show active
            if (contents[tabName]) {
                contents[tabName].classList.remove('hidden');
                tabs[tabName].classList.remove('border-transparent', 'text-gray-500');
                tabs[tabName].classList.add('border-indigo-500', 'text-gray-900');
            }
        }

        // --- Tool 1 Logic (Wrapped) ---
        (function() {
            // --- Constants & State ---
            const DEFAULT_TARGETS = [
                "01.01.0010", "01.01.0020", "01.01.0030", "01.01.0040", "01.01.0050",
                "01.01.0060", "01.01.0070", "01.01.0080", "01.01.0090", "01.01.0100",
                "01.01.0110", "01.01.0120", "01.01.0130", "01.01.0140", "01.01.0150",
                "01.01.0160", "01.01.0170", "01.01.0180", "01.01.0190", "01.01.0200",
                "01.01.0210", "01.01.0220", "01.01.0230", "01.01.0240", "01.01.0250",
                "01.01.0260", "01.01.0270", "01.01.0280", "01.01.0290", "01.01.0300",
                "01.01.0310", "01.01.0320", "01.01.0330", "01.01.0340", "01.02.0010",
                "01.02.0020", "01.02.0030", "01.02.0040", "01.02.0050", "01.02.0060",
                "01.02.0070", "01.02.0080", "01.03.0010", "01.03.0020", "01.03.0030",
                "01.03.0040", "01.03.0050", "01.03.0060", "01.03.0070", "01.03.0080",
                "01.03.0090", "01.03.0100", "01.03.0110", "01.04.0010", "01.04.0020",
                "01.04.0030", "01.04.0040", "01.04.0050", "01.04.0060", "01.04.0070",
                "01.04.0080", "01.04.0090", "01.05.0010", "01.05.0020", "01.05.0030",
                "01.05.0040", "01.06.0010", "01.06.0020", "01.06.0030", "01.06.0040",
                "01.06.0050"
            ];

            let currentTargets = [];
            let currentResults = []; // For CSV export
            let extractedHeader = {}; // For CSV export
            let sortState = { column: 'count', direction: 'desc' }; // Default sort

            // --- Elements ---
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const feedback = document.getElementById('feedback');
            const resultsContainer = document.getElementById('resultsContainer');
            const targetValuesArea = document.getElementById('targetValuesArea');
            const updateTargetsBtn = document.getElementById('updateTargets');
            const toggleConfigBtn = document.getElementById('toggleConfigBtn');
            const configPanel = document.getElementById('configPanel');
            const configIcon = document.getElementById('configIcon');

            // --- Initialization ---
            function init() {
                resetDefaultTargets();
                updateTargets(); // Load defaults into memory

                // Listeners
                updateTargetsBtn.addEventListener('click', () => {
                    updateTargets();
                    showFeedback('Targets updated successfully!', 'success');
                });

                toggleConfigBtn.addEventListener('click', () => {
                    configPanel.classList.toggle('hidden');
                    configIcon.classList.toggle('ph-caret-up');
                    configIcon.classList.toggle('ph-caret-down');
                });

                fileInput.addEventListener('change', handleFileSelect);

                // Drag effects
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        dropArea.querySelector('div').classList.add('drag-active');
                    }, false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        dropArea.querySelector('div').classList.remove('drag-active');
                    }, false);
                });
                dropArea.addEventListener('drop', handleDrop, false);
            }

            // --- Core Logic ---

            function resetDefaultTargets() {
                targetValuesArea.value = DEFAULT_TARGETS.join('\n');
            }

            function updateTargets() {
                currentTargets = targetValuesArea.value
                    .split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
            }

            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) processFile(file);
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                if (file) processFile(file);
            }

            function showFeedback(msg, type) {
                feedback.className = `rounded-lg p-4 text-center text-sm font-medium mb-6 ${
                    type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' :
                    type === 'loading' ? 'bg-blue-50 text-blue-700 border border-blue-200 flex justify-center items-center gap-2' :
                    'bg-green-50 text-green-700 border border-green-200'
                }`;

                if(type === 'loading') {
                    feedback.innerHTML = `<div class="loader"></div> ${msg}`;
                } else {
                    feedback.textContent = msg;
                }
                feedback.classList.remove('hidden');
            }

            function processFile(file) {
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    showFeedback('Invalid file type. Please upload an Excel (.xlsx) file.', 'error');
                    return;
                }

                showFeedback(`Processing ${file.name}...`, 'loading');
                resultsContainer.classList.add('hidden');

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        if (workbook.SheetNames.length === 0) throw new Error("No sheets found.");
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];

                        // KEY FIX: raw: false ensures we get the formatted string (e.g., "01.01.2020")
                        // instead of the Excel serial number (e.g., 43831).
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });

                        analyzeData(rows);
                    } catch (err) {
                        console.error(err);
                        showFeedback(`Error reading file: ${err.message}`, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function analyzeData(rows) {
                // 1. Extract Headers
                const datum = findValue(rows, "Nr.:");
                const auftrag = findValue(rows, "Auftrag Nr.:");
                const inv = findValue(rows, "INV:");
                const anlage = findValue(rows, "Anlage:");
                const ort = findOrtValue(rows); // Special logic for 2nd occurrence

                extractedHeader = {
                    datum: datum || "Not Found",
                    auftrag: auftrag || "Not Found",
                    anlage: (inv || anlage) ? `${inv || ''}_${anlage || ''}` : "N/A",
                    ort: ort || "Not Found"
                };

                // Update Header UI
                document.getElementById('outDatum').textContent = extractedHeader.datum;
                document.getElementById('outAuftrag').textContent = extractedHeader.auftrag;
                document.getElementById('outAnlage').textContent = extractedHeader.anlage;
                document.getElementById('outOrt').textContent = extractedHeader.ort;

                // 2. Count Occurrences
                const counts = new Map();
                let totalMatches = 0;
                let debugRows = [];

                // Initialize Map with 0 for all targets
                currentTargets.forEach(t => counts.set(t, 0));

                // Iterate Rows
                rows.forEach((row, idx) => {
                    // Column A is index 0. Ensure it's a string.
                    const cellVal = String(row[0] || "").trim();

                    if (!cellVal) return;

                    // Debug first 5 rows
                    if (debugRows.length < 5) debugRows.push(cellVal);

                    // Check against targets
                    currentTargets.forEach(target => {
                        if (cellVal.includes(target)) {
                            counts.set(target, counts.get(target) + 1);
                            totalMatches++;
                        }
                    });
                });

                // 3. Render Table
                renderTable(counts, totalMatches, rows.length);

                // 4. Show Debug if no matches
                const debugArea = document.getElementById('debugArea');
                if (totalMatches === 0) {
                    debugArea.classList.remove('hidden');
                    document.getElementById('debugList').innerHTML = debugRows.map(v => `<li>${v}</li>`).join('');
                } else {
                    debugArea.classList.add('hidden');
                }

                showFeedback('Analysis complete.', 'success');
                resultsContainer.classList.remove('hidden');
            }

            // --- Helper Functions ---

            // Finds a label (searchStr) and returns the NEXT non-empty cell in that row.
            function findValue(rows, searchStr) {
                for (let r = 0; r < rows.length; r++) {
                    const row = rows[r];
                    for (let c = 0; c < row.length; c++) {
                        const cell = String(row[c] || "");
                        if (cell.includes(searchStr)) {
                            // Found label, scan rest of row for value
                            for (let k = c + 1; k < row.length; k++) {
                                const val = String(row[k] || "").trim();
                                if (val) return val;
                            }
                        }
                    }
                }
                return null;
            }

            // Specific requirement: Find the SECOND occurrence of "Ort:"
            function findOrtValue(rows) {
                let occurrences = 0;
                for (let r = 0; r < rows.length; r++) {
                    const row = rows[r];
                    for (let c = 0; c < row.length; c++) {
                        const cell = String(row[c] || "");
                        if (cell.includes("Ort:")) {
                            occurrences++;
                            if (occurrences === 2) {
                                // Found 2nd occurrence, scan rest of row
                                for (let k = c + 1; k < row.length; k++) {
                                    const val = String(row[k] || "").trim();
                                    if (val) return val;
                                }
                            }
                        }
                    }
                }
                return null;
            }

            function handleSort(column) {
                if (sortState.column === column) {
                    // Toggle direction
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    // New column, default to descending for count, ascending for target
                    sortState.column = column;
                    sortState.direction = column === 'count' ? 'desc' : 'asc';
                }

                // Re-render with cached data
                if (lastCountsMap) {
                    renderTable(lastCountsMap, lastTotalMatches, lastRowCount);
                }
            }

            let lastCountsMap = null;
            let lastTotalMatches = 0;
            let lastRowCount = 0;

            function renderTable(countsMap, totalMatches, rowCount) {
                // Store for sorting re-renders
                lastCountsMap = countsMap;
                lastTotalMatches = totalMatches;
                lastRowCount = rowCount;

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                document.getElementById('matchSummary').textContent =
                    `Found ${totalMatches} matches across ${rowCount} processed rows.`;

                // Update Sort Icons
                ['target', 'count'].forEach(col => {
                    const icon = document.getElementById(`sort-icon-${col}`);
                    if(icon) {
                        if (sortState.column === col) {
                            icon.className = sortState.direction === 'asc'
                                ? 'ph ph-arrow-up text-indigo-600'
                                : 'ph ph-arrow-down text-indigo-600';
                        } else {
                            icon.className = 'ph ph-arrows-down-up text-slate-400';
                        }
                    }
                });

                // Filter only positive counts
                let sorted = Array.from(countsMap.entries())
                    .filter(([_, count]) => count > 0);

                // Sort logic
                sorted.sort((a, b) => {
                    const valA = a[0];
                    const countA = a[1];
                    const valB = b[0];
                    const countB = b[1];

                    if (sortState.column === 'count') {
                        return sortState.direction === 'asc' ? countA - countB : countB - countA;
                    } else {
                        // Target value sort (string)
                        return sortState.direction === 'asc'
                            ? valA.localeCompare(valB, undefined, { numeric: true })
                            : valB.localeCompare(valA, undefined, { numeric: true });
                    }
                });

                if (sorted.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500 italic">No targets found in Column A</td></tr>`;
                    currentResults = [];
                    return;
                }

                currentResults = sorted; // Save for CSV

                sorted.forEach(([target, count]) => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50 transition-colors";
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-indigo-700 font-medium">${target}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-bold">${count}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Found</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // --- Export Features ---

            // Made global within this scope so the buttons can call them.
            // In the HTML above, onclick="copyToClipboard('outDatum')" refers to global scope.
            // We need to attach these to window for the inline onclicks to work.
            window.copyToClipboard = function(elementId) {
                const text = document.getElementById(elementId).textContent;
                if (text && text !== '-' && text !== 'Not Found') {
                    navigator.clipboard.writeText(text).then(() => {
                        showFeedback(`Copied "${text}" to clipboard!`, 'success');
                    });
                }
            };

            window.copyTableToClipboard = function() {
                if (!currentResults.length) return;
                let text = "Target Value\\tCount\\n";
                currentResults.forEach(r => text += `${r[0]}\\t${r[1]}\\n`);
                navigator.clipboard.writeText(text).then(() => showFeedback("Table copied to clipboard!", 'success'));
            };

            window.downloadCSV = function() {
                if (!currentResults.length) return;

                // Create CSV Content
                // Add Header Info at top
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += `Protokoll,${extractedHeader.datum}\\n`;
                csvContent += `Auftrag,${extractedHeader.auftrag}\\n`;
                csvContent += `Anlage,${extractedHeader.anlage}\\n`;
                csvContent += `Ort,${extractedHeader.ort}\\n\\n`;

                // Add Table Data
                csvContent += "Target Value,Count\\n";
                currentResults.forEach(row => {
                    csvContent += `${row[0]},${row[1]}\\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `analysis_results_${extractedHeader.auftrag || 'export'}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Also need global access to resetDefaultTargets if used in onclick
             window.resetDefaultTargets = resetDefaultTargets;

             window.handleSort = handleSort;

            // Run init
            init();
        })();

        // --- Tool 2 Logic (Wrapped) ---
        (function() {
            // Initialize Icons
            lucide.createIcons();

            // --- Global State ---
            let state = {
                totalSum: 0,
                validRecords: 0,
                extractedData: [], // Store data for export
                sort: { column: null, direction: 'asc' },
                filter: ''
            };

            const UI = {
                tableBody: document.getElementById('table-body'),
                emptyState: document.getElementById('empty-state'),
                dropArea: document.getElementById('drop-area'),
                totalDisplay: document.getElementById('total-display'),
                countDisplay: document.getElementById('count-display'),
                badgeCount: document.getElementById('record-count-badge'),
                exportBtn: document.getElementById('btn-export')
            };

            // --- Drag and Drop Setup ---
            const events = ['dragenter', 'dragover', 'dragleave', 'drop'];

            events.forEach(evt => {
                UI.dropArea.addEventListener(evt, preventDefaults, false);
                document.body.addEventListener(evt, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(evt => {
                UI.dropArea.addEventListener(evt, () => UI.dropArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(evt => {
                UI.dropArea.addEventListener(evt, () => UI.dropArea.classList.remove('dragover'), false);
            });

            UI.dropArea.addEventListener('drop', handleDrop, false);
            UI.dropArea.addEventListener('click', () => document.getElementById('fileElem').click());

            // Filter listener
            const filterInput = document.getElementById('filter-input-extractor');
            if (filterInput) {
                filterInput.addEventListener('keyup', (e) => {
                    state.filter = e.target.value.toLowerCase();
                    renderTable();
                });
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                handleFiles(dt.files);
            }

            // Made global for onchange="handleFiles(this.files)"
            window.handleFiles = function(files) {
                const filesArray = [...files];
                const excelFiles = filesArray.filter(file => file.name.match(/\.xlsx$|\.xls$/));

                if (excelFiles.length === 0 && filesArray.length > 0) {
                    showNotification('Nur Excel-Dateien (.xlsx, .xls) erlaubt.', 'error');
                    return;
                }

                // Process files
                excelFiles.forEach(readExcel);

                // Reset input so same file can be selected again if needed
                document.getElementById('fileElem').value = '';
            };

            // --- Core Processing Logic ---

            function readExcel(file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Assume first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Convert to Array of Arrays (header: 1 gives raw array)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                        processData(jsonData, file.name);
                        showNotification(`Dateigelesen: ${file.name}`, 'success');

                    } catch (err) {
                        console.error(err);
                        showNotification(`Fehler bei ${file.name}`, 'error');
                    }
                };

                reader.readAsArrayBuffer(file);
            }

            // Helper: Clean string for comparison
            const cleanStr = (val) => String(val || '').trim().toLowerCase();

            function parseExcelDate(value) {
                if (!value) return "";
                // Excel numeric date
                if (typeof value === 'number') {
                    const dateObj = XLSX.SSF.parse_date_code(value);
                    if(dateObj) {
                        const day = String(dateObj.d).padStart(2, '0');
                        const month = String(dateObj.m).padStart(2, '0');
                        return `${day}.${month}.${dateObj.y}`;
                    }
                }
                // If it's already a string, assume it's fine but maybe trim it
                return String(value).trim();
            }

            function parseCurrency(value) {
                if (!value) return 0;
                if (typeof value === 'number') return value;

                // Remove currency symbols and whitespace
                // Handles: "1.000,00 €", "1,000.00", "1000"
                let clean = String(value).replace(/[^\d.,-]/g, '').trim();

                // German format detection (comma is decimal separator if it appears last or only separator)
                // 1.000,00 -> matches German
                // 1,000.00 -> matches US

                if (clean.indexOf(',') > -1 && clean.indexOf('.') > -1) {
                    if (clean.lastIndexOf(',') > clean.lastIndexOf('.')) {
                        // German: 1.234,56
                        clean = clean.replace(/\./g, '').replace(',', '.');
                    } else {
                        // US: 1,234.56
                        clean = clean.replace(/,/g, '');
                    }
                } else if (clean.indexOf(',') > -1) {
                    // Assume German decimal only: 50,00
                    clean = clean.replace(',', '.');
                }

                const num = parseFloat(clean);
                return isNaN(num) ? 0 : num;
            }

            /**
             * Flexible Finder
             * logicType:
             * 'next_col': cell to the right
             * 'prev_col': cell to the left
             * 'next_row': cell below
             */
            function findValueInMatrix(matrix, searchLabel, logicType) {
                const label = cleanStr(searchLabel);

                for (let r = 0; r < matrix.length; r++) {
                    const row = matrix[r];
                    if (!row) continue;

                    for (let c = 0; c < row.length; c++) {
                        const cellValue = cleanStr(row[c]);

                        // Flexible match check
                        if (cellValue.includes(label) && cellValue.length > 0) {

                            // 1. Next Column (Scan right up to 5 cells for non-empty)
                            if (logicType === 'next_col') {
                                for (let offset = 1; offset <= 5; offset++) {
                                    let val = row[c + offset];
                                    if (val !== undefined && val !== null && String(val).trim() !== "") {
                                        return val;
                                    }
                                }
                                return "";
                            }

                            // 2. Previous Column (Immediate left)
                            if (logicType === 'prev_col') {
                                let val = row[c - 1];
                                return (val !== undefined && val !== null && String(val).trim() !== "") ? val : "";
                            }

                            // 3. Next Row (Below)
                            if (logicType === 'next_row') {
                                if (matrix[r + 1]) {
                                    let val = matrix[r + 1][c];
                                    return (val !== undefined && val !== null && String(val).trim() !== "") ? val : "";
                                }
                                return "";
                            }
                        }
                    }
                }
                return "";
            }

            function processData(matrix, fileName) {
                // Hide empty state
                if (UI.emptyState) UI.emptyState.style.display = 'none';

                // Extraction Configuration
                // Adjust search terms here if Excel templates change
                const rawDatum = findValueInMatrix(matrix, "Datum", 'next_col');
                const datum = parseExcelDate(rawDatum) || rawDatum; // Try parse, fallback to raw

                const auftragsNr = findValueInMatrix(matrix, "Auftrags-Nr.", 'next_col');
                const anlage = findValueInMatrix(matrix, "Anlage", 'next_col');
                const einsatzort = findValueInMatrix(matrix, "Einsatzort", 'next_col');

                // Logic: Sometimes value is BEFORE label like "4.5 Fachmonteurstunde"
                const fachmonteur = findValueInMatrix(matrix, "Fachmonteurstunde", 'prev_col');

                const bemerkung = findValueInMatrix(matrix, "Bemerkung", 'next_row');

                const rawSum = findValueInMatrix(matrix, "Auftragssumme", 'next_col');
                const parsedSum = rawSum !== "" ? parseCurrency(rawSum) : 0;

                // Prevent adding empty rows if essentially no data found
                if (!datum && !auftragsNr && !parsedSum) {
                    showNotification(`Keine relevanten Daten in ${fileName} gefunden`, 'error');
                    return;
                }

                // Update Global State
                if (parsedSum > 0) {
                    state.totalSum += parsedSum;
                    state.validRecords++;
                }

                // Save for Export
                const record = {
                    fileName,
                    datum,
                    auftragsNr,
                    anlage,
                    einsatzort,
                    fachmonteur,
                    sumRaw: parsedSum,
                    bemerkung
                };
                state.extractedData.push(record);

                updateUI();
                renderTable();
            }

            function handleExtractorSort(column) {
                if (state.sort.column === column) {
                    state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    state.sort.column = column;
                    state.sort.direction = 'asc';
                }
                renderTable();
            }
            // Make Global
            window.handleExtractorSort = handleExtractorSort;

            function renderTable() {
                // Clear Table
                UI.tableBody.innerHTML = '';

                // Filter
                let filtered = state.extractedData.filter(item => {
                    if (!state.filter) return true;
                    return Object.values(item).some(val =>
                        String(val).toLowerCase().includes(state.filter)
                    );
                });

                // Sort
                if (state.sort.column) {
                    const col = state.sort.column;
                    const dir = state.sort.direction === 'asc' ? 1 : -1;

                    filtered.sort((a, b) => {
                        let valA = a[col];
                        let valB = b[col];

                        // Numeric sort for Sum
                        if (col === 'sumRaw') {
                            return (valA - valB) * dir;
                        }

                        // String sort
                        return String(valA).localeCompare(String(valB), undefined, { numeric: true }) * dir;
                    });
                }

                // Update Icons
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.classList.add('opacity-30');
                    icon.setAttribute('data-lucide', 'arrow-up-down');
                    icon.classList.remove('text-blue-600', 'opacity-100');
                });

                if (state.sort.column) {
                    const activeIcon = document.getElementById(`sort-${state.sort.column}`);
                    if (activeIcon) {
                        activeIcon.setAttribute('data-lucide', state.sort.direction === 'asc' ? 'arrow-up' : 'arrow-down');
                        activeIcon.classList.remove('opacity-30');
                        activeIcon.classList.add('opacity-100', 'text-blue-600');
                    }
                }

                // Render Rows
                if (filtered.length === 0) {
                    UI.tableBody.appendChild(UI.emptyState);
                    if (state.extractedData.length > 0) {
                       UI.emptyState.querySelector('span').textContent = "Keine Ergebnisse für den Filter";
                       UI.emptyState.style.display = 'table-row';
                    }
                } else {
                    filtered.forEach(data => {
                        const tr = document.createElement('tr');
                        const hasBemerkung = data.bemerkung && String(data.bemerkung).trim().length > 0;
                        const baseBg = hasBemerkung ? "bg-orange-50" : "bg-white";
                        tr.className = `${baseBg} hover:bg-blue-50 transition-colors fade-in group`;

                        // Format Currency for Display
                        const sumDisplay = (data.sumRaw > 0)
                            ? data.sumRaw.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })
                            : '-';

                        // Safe HTML injection helper
                        const safe = (txt) => txt ? String(txt) : '';

                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-xs font-medium text-slate-400 border-b border-slate-100">
                                <div class="flex items-center gap-2 max-w-[150px]">
                                    <i data-lucide="file" class="w-3 h-3 flex-shrink-0"></i>
                                    <span class="truncate" title="${safe(data.fileName)}">${safe(data.fileName)}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-700 font-mono text-xs bg-slate-50 rounded">${safe(data.auftragsNr)}</td>
                            <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-xs max-w-[150px] truncate" title="${safe(data.anlage)}">${safe(data.anlage)}</td>
                            <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-xs max-w-[150px] truncate" title="${safe(data.einsatzort)}">${safe(data.einsatzort)}</td>
                            <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-700">${safe(data.datum)}</td>
                            <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-center">${safe(data.fachmonteur)}</td>
                            <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-right font-mono text-slate-800 font-semibold">${sumDisplay}</td>
                            <td class="px-6 py-4 border-b border-slate-100 text-slate-500 text-xs min-w-[200px] leading-relaxed">${safe(data.bemerkung)}</td>
                        `;
                        UI.tableBody.appendChild(tr);
                    });
                }

                lucide.createIcons();
            }

            function updateUI() {
                UI.totalDisplay.textContent = state.totalSum.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
                UI.countDisplay.textContent = state.validRecords;
                UI.badgeCount.textContent = state.validRecords;

                if (state.validRecords > 0) {
                    UI.badgeCount.classList.remove('hidden');
                    UI.exportBtn.disabled = false;
                    UI.exportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // Made global for onclick="clearTable()"
            window.clearTable = function() {
                UI.tableBody.innerHTML = '';
                UI.tableBody.appendChild(UI.emptyState);
                UI.emptyState.style.display = 'table-row';

                // Reset State
                state.totalSum = 0;
                state.validRecords = 0;
                state.extractedData = [];

                // Reset UI
                UI.badgeCount.classList.add('hidden');
                UI.exportBtn.disabled = true;
                UI.exportBtn.classList.add('opacity-50', 'cursor-not-allowed');

                updateUI();
                showNotification('Tabelle geleert', 'success');
            };

            // Made global for onclick="exportToExcel()"
            window.exportToExcel = function() {
                if (state.extractedData.length === 0) return;

                // Prepare data for export (clean headers)
                const wsData = state.extractedData.map(item => ({
                    "Dateiname": item.fileName,
                    "Auftragsnummer": item.auftragsNr,
                    "Anlage": item.anlage,
                    "Einsatzort": item.einsatzort,
                    "Datum": item.datum,
                    "Fachmonteurstunden": item.fachmonteur,
                    "Auftragssumme": item.sumRaw, // Keep as number for Excel math
                    "Bemerkung": item.bemerkung
                }));

                const ws = XLSX.utils.json_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Exportierte Daten");

                // Generate filename with timestamp
                const dateStr = new Date().toISOString().slice(0,10);
                XLSX.writeFile(wb, `Export_Daten_${dateStr}.xlsx`);

                showNotification('Excel-Datei heruntergeladen!', 'success');
            };

            // --- Notification System ---
            function showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                const styles = type === 'error'
                    ? 'bg-red-50 text-red-600 border-red-200'
                    : 'bg-emerald-50 text-emerald-600 border-emerald-200';

                const icon = type === 'error' ? 'alert-circle' : 'check-circle-2';

                notif.className = `${styles} border px-4 py-3 rounded-lg shadow-lg transform transition-all duration-500 translate-y-10 opacity-0 flex items-center gap-3 text-sm font-medium min-w-[300px]`;
                notif.innerHTML = `
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                    <span>${message}</span>
                `;

                document.getElementById('notification-area').appendChild(notif);
                lucide.createIcons();

                // Animate In
                requestAnimationFrame(() => notif.classList.remove('translate-y-10', 'opacity-0'));

                // Remove after 3s
                setTimeout(() => {
                    notif.classList.add('translate-y-4', 'opacity-0');
                    setTimeout(() => notif.remove(), 500);
                }, 3000);
            }
        })();

        // --- Tool 3 Logic (Row Manager) ---
        (function() {
            let rmHeaders = [];
            let rmData = [];
            let draggedRow = null;

            const UI = {
                fileInput: document.getElementById('rm-file-input'),
                dropArea: document.getElementById('rm-drop-area'),
                results: document.getElementById('rm-results'),
                theadTr: document.getElementById('rm-thead-tr'),
                tbody: document.getElementById('rm-tbody'),
                status: document.getElementById('rm-status')
            };

            // Init listeners
            if(UI.fileInput) UI.fileInput.addEventListener('change', handleFileSelect);

            // Upload Area Drag & Drop
            if(UI.dropArea) {
                ['dragenter', 'dragover'].forEach(eventName => {
                    UI.dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        UI.dropArea.querySelector('div').classList.add('border-indigo-400', 'bg-indigo-50');
                    }, false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    UI.dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        UI.dropArea.querySelector('div').classList.remove('border-indigo-400', 'bg-indigo-50');
                    }, false);
                });
                UI.dropArea.addEventListener('drop', handleDropFile, false);
            }

            // Table Event Delegation
            if (UI.tbody) {
                UI.tbody.addEventListener('click', handleTableClick);
                UI.tbody.addEventListener('dragstart', handleRowDragStart);
                UI.tbody.addEventListener('dragover', handleRowDragOver);
                UI.tbody.addEventListener('drop', handleRowDrop);
                UI.tbody.addEventListener('dragend', handleRowDragEnd);
            }

            // --- File Handling ---

            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) processFile(file);
                e.target.value = '';
            }

            function handleDropFile(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                if (file) processFile(file);
            }

            function processFile(file) {
                 if (!file.name.match(/\.(xlsx|xls)$/)) {
                    showNotification("Please upload a valid Excel file.", 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

                        if (json.length > 0) {
                            rmHeaders = json[0];
                            rmData = json.slice(1);
                            renderTable();
                            UI.dropArea.classList.add('hidden');
                            UI.results.classList.remove('hidden');
                            showNotification(`Loaded ${file.name}`, 'success');
                        } else {
                             showNotification("Empty file.", 'error');
                        }
                    } catch(err) {
                        console.error(err);
                        showNotification("Error processing file", 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            // --- Rendering ---

            function renderTable() {
                UI.status.textContent = `${rmData.length} Rows`;

                // Render Headers
                UI.theadTr.innerHTML = rmHeaders.map(h =>
                    `<th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider whitespace-nowrap bg-slate-50 border-b border-slate-200 select-none">${h || '-'}</th>`
                ).join('') +
                `<th class="px-4 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-50 border-b border-slate-200 sticky right-0 shadow-[-10px_0_10px_-5px_rgba(0,0,0,0.05)] z-20">Actions</th>`;

                // Render Body (String Concatenation for Performance)
                const rowsHtml = rmData.map((row) => {
                    const cellsHtml = row.map(cell =>
                        `<td class="px-4 py-2 whitespace-nowrap text-slate-700 border-b border-slate-100 text-xs pointer-events-none">${cell}</td>`
                    ).join('');

                    return `
                    <tr draggable="true" class="hover:bg-indigo-50 transition-colors bg-white group cursor-move">
                        ${cellsHtml}
                        <td class="px-4 py-2 whitespace-nowrap border-b border-slate-100 text-right sticky right-0 bg-white group-hover:bg-indigo-50 shadow-[-10px_0_10px_-5px_rgba(0,0,0,0.05)] z-10">
                            <div class="flex justify-end gap-2">
                                <button type="button" class="js-copy p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-white rounded border border-transparent hover:border-slate-200 transition-all" title="Copy Row">
                                    <i class="ph ph-copy text-lg pointer-events-none"></i>
                                </button>
                                <button type="button" class="js-bulk-copy p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-white rounded border border-transparent hover:border-slate-200 transition-all" title="Bulk Copy (Next 22)">
                                    <i class="ph ph-stack text-lg pointer-events-none"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');

                UI.tbody.innerHTML = rowsHtml;
            }

            // --- Interactive Logic (Delegation) ---

            function handleTableClick(e) {
                const btn = e.target.closest('button');
                if (!btn) return;

                const tr = btn.closest('tr');
                if (!tr) return;

                // Calculate index dynamically based on current DOM order
                const index = Array.from(UI.tbody.children).indexOf(tr);
                if (index === -1) return;

                if (btn.classList.contains('js-copy')) {
                    copyRow(index);
                } else if (btn.classList.contains('js-bulk-copy')) {
                    bulkCopy(index);
                }
            }

            function copyRow(index) {
                const row = rmData[index];
                if (!row) return;
                const text = row.join('\t');
                navigator.clipboard.writeText(text).then(() => showNotification("Row copied!", "success"));
            }

            function bulkCopy(index) {
                const rows = rmData.slice(index, index + 22);
                if (!rows.length) return;
                const text = rows.map(r => r.join('\t')).join('\n');
                navigator.clipboard.writeText(text).then(() => showNotification(`Copied ${rows.length} rows!`, "success"));
            }

            // --- Optimized Drag & Drop ---

            function handleRowDragStart(e) {
                const tr = e.target.closest('tr');
                if (!tr) return;

                draggedRow = tr;
                tr.classList.add('opacity-50', 'bg-indigo-100');
                e.dataTransfer.effectAllowed = 'move';
                // Set data for compatibility, though we use state var 'draggedRow'
                e.dataTransfer.setData('text/plain', '');
            }

            function handleRowDragOver(e) {
                e.preventDefault(); // Necessary to allow dropping
                const tr = e.target.closest('tr');
                if (!tr || tr === draggedRow) return;

                e.dataTransfer.dropEffect = 'move';

                // Visual Indicator
                // Remove existing indicators
                UI.tbody.querySelectorAll('.border-t-2', '.border-b-2', '.border-indigo-500').forEach(el => {
                    el.style.borderTop = '';
                    el.style.borderBottom = '';
                });

                // Calculate whether to drop before or after based on mouse Y
                const rect = tr.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;

                if (next) {
                    tr.style.borderBottom = '2px solid #6366f1';
                } else {
                    tr.style.borderTop = '2px solid #6366f1';
                }
            }

            function handleRowDrop(e) {
                e.stopPropagation();
                e.preventDefault();

                const targetRow = e.target.closest('tr');

                // Cleanup Styles
                UI.tbody.querySelectorAll('tr').forEach(el => {
                    el.style.borderTop = '';
                    el.style.borderBottom = '';
                    el.classList.remove('bg-indigo-100', 'opacity-50');
                });

                if (draggedRow && targetRow && draggedRow !== targetRow) {
                    // Determine position
                    const rect = targetRow.getBoundingClientRect();
                    const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;

                    // 1. Update Data Model
                    const fromIndex = Array.from(UI.tbody.children).indexOf(draggedRow);
                    let toIndex = Array.from(UI.tbody.children).indexOf(targetRow);

                    if (next) toIndex++; // If dropping after, increment index

                    // Adjust toIndex if moving downwards because removal shifts indices
                    if (fromIndex < toIndex) toIndex--;

                    // Move Data
                    const item = rmData.splice(fromIndex, 1)[0];
                    rmData.splice(toIndex, 0, item);

                    // 2. Update DOM directly (No Re-render)
                    if (next) {
                        UI.tbody.insertBefore(draggedRow, targetRow.nextSibling);
                    } else {
                        UI.tbody.insertBefore(draggedRow, targetRow);
                    }
                }

                draggedRow = null;
            }

            function handleRowDragEnd(e) {
                if (draggedRow) {
                    draggedRow.classList.remove('opacity-50', 'bg-indigo-100');
                    draggedRow = null;
                }
                UI.tbody.querySelectorAll('tr').forEach(el => {
                    el.style.borderTop = '';
                    el.style.borderBottom = '';
                });
            }

            // Global Actions (Exposed)
            window.rmClear = function() {
                rmData = [];
                rmHeaders = [];
                UI.results.classList.add('hidden');
                UI.dropArea.classList.remove('hidden');
                UI.fileInput.value = '';
            };

            // Notification Helper
            function showNotification(msg, type) {
                 const area = document.getElementById('notification-area');
                 const el = document.createElement('div');
                 const styles = type === 'error'
                    ? 'bg-red-50 text-red-600 border-red-200'
                    : 'bg-emerald-50 text-emerald-600 border-emerald-200';
                 const icon = type === 'error' ? 'alert-circle' : 'check-circle-2';

                 el.className = `${styles} border px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 text-sm font-medium animate-in slide-in-from-bottom-5 fade-in duration-300`;
                 el.innerHTML = `<span>${msg}</span>`;

                 if(area) area.appendChild(el);
                 setTimeout(() => {
                     el.classList.add('opacity-0', 'translate-y-2', 'transition-all');
                     setTimeout(() => el.remove(), 500);
                 }, 2000);
            }

        })();

    </script>
</body>
</html>