<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Excel Tools</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Phosphor Icons (Tool 1) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Lucide Icons (Tool 2) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts (Tool 2) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Shared Styles */
        body { font-family: 'Inter', sans-serif; }

        /* Tool 1 Styles */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        textarea::-webkit-scrollbar-track { background-color: #f8fafc; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        @keyframes pulse-border {
            0% { border-color: #6366f1; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { border-color: #4f46e5; box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { border-color: #6366f1; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .drag-active {
            animation: pulse-border 2s infinite;
            background-color: #eef2ff;
            border-color: #4f46e5;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tool 2 Styles */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dragover {
            background-color: #eff6ff;
            border-color: #3b82f6;
            border-style: solid;
            transform: scale(1.005);
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="font-bold text-xl text-slate-800">Excel Tools Suite</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <button onclick="switchTab('tool1')" id="tab-tool1" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Value Counter
                        </button>
                        <button onclick="switchTab('tool2')" id="tab-tool2" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Smart Extractor
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

        <!-- Tool 1: Excel Value Counter -->
        <div id="tool1-content" class="block">

    <div class="max-w-5xl mx-auto space-y-6">

        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
                    <i class="ph ph-file-xls text-3xl"></i>
                    Excel Column A Counter
                </h1>
                <p class="text-slate-500 text-sm mt-1">Parses headers and counts substring occurrences in Column A.</p>
            </div>
            <button onclick="window.location.reload()" class="text-sm text-slate-500 hover:text-indigo-600 underline">Reset Tool</button>
        </div>

        <!-- Configuration Section (Collapsible) -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <button id="toggleConfigBtn" class="w-full flex items-center justify-between p-4 bg-slate-50 hover:bg-slate-100 transition-colors text-left">
                <span class="font-semibold text-slate-700 flex items-center gap-2">
                    <i class="ph ph-gear"></i> Configuration: Target Values
                </span>
                <i id="configIcon" class="ph ph-caret-down text-slate-500"></i>
            </button>

            <div id="configPanel" class="p-4 border-t border-slate-200 hidden">
                <div class="flex justify-between items-end mb-2">
                    <label for="targetValuesArea" class="text-sm font-medium text-slate-600">
                        Enter values to search for (one per line):
                    </label>
                    <button onclick="resetDefaultTargets()" class="text-xs text-indigo-600 hover:underline">Restore Defaults</button>
                </div>
                <textarea id="targetValuesArea" rows="10"
                    class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm text-slate-700 bg-slate-50"
                    placeholder="01.01.0010..."></textarea>
                <button id="updateTargets" class="mt-3 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 shadow-sm flex items-center gap-2">
                    <i class="ph ph-check"></i> Save & Update Targets
                </button>
            </div>
        </div>

        <!-- Drag & Drop Zone -->
        <div id="dropArea" class="relative group cursor-pointer">
            <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".xlsx, .xls">
            <div class="w-full h-48 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center bg-white transition-all group-hover:border-indigo-400 group-hover:bg-indigo-50">
                <div class="p-4 rounded-full bg-indigo-50 text-indigo-600 mb-3 group-hover:scale-110 transition-transform">
                    <i class="ph ph-upload-simple text-4xl"></i>
                </div>
                <p class="text-lg font-medium text-slate-700">Drop your <span class="text-indigo-600 font-bold">.xlsx</span> file here</p>
                <p class="text-sm text-slate-400 mt-1">or click to browse</p>
            </div>
        </div>

        <!-- Status Feedback -->
        <div id="feedback" class="hidden rounded-lg p-4 text-center text-sm font-medium"></div>

        <!-- Results Container -->
        <div id="resultsContainer" class="hidden space-y-6">

            <!-- 1. Extracted Headers -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-list-magnifying-glass text-indigo-600"></i> Extracted Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Protokoll (Nr.)</span>
                        <span id="outDatum" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                        <button onclick="copyToClipboard('outDatum')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Auftrags-Nr.</span>
                        <span id="outAuftrag" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                        <button onclick="copyToClipboard('outAuftrag')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Anlage (INV_Anlage)</span>
                        <span id="outAnlage" class="block text-lg font-semibold text-slate-800 mt-1 break-all">-</span>
                        <button onclick="copyToClipboard('outAnlage')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 relative group">
                        <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Einsatzort</span>
                        <span id="outOrt" class="block text-lg font-semibold text-slate-800 mt-1">-</span>
                        <button onclick="copyToClipboard('outOrt')" class="absolute top-2 right-2 text-slate-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                            <i class="ph ph-copy"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Count Table -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Target Matches</h2>
                        <p id="matchSummary" class="text-sm text-slate-500">Found 0 matches in 0 rows.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyTableToClipboard()" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 text-slate-600 flex items-center gap-2 transition-colors">
                            <i class="ph ph-copy"></i> Copy
                        </button>
                        <button onclick="downloadCSV()" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 text-slate-600 flex items-center gap-2 transition-colors">
                            <i class="ph ph-download-simple"></i> CSV
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200" id="resultsTable">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Target Value</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Count</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-slate-200">
                            <!-- Rows generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Debug Info -->
            <div id="debugArea" class="hidden p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                <p class="font-bold mb-2"><i class="ph ph-warning-circle"></i> Debugging Info (First 5 values found in Column A):</p>
                <ul id="debugList" class="list-disc list-inside font-mono text-xs"></ul>
                <p class="mt-2 text-xs">If matches are 0, ensure the format above looks like your target list.</p>
            </div>

        </div>
    </div>
        </div>

        <!-- Tool 2: Smart Excel Extractor -->
        <div id="tool2-content" class="hidden">

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">

        <!-- Upload Section -->
        <div class="mb-8">
            <div id="drop-area" class="group relative w-full h-48 border-2 border-dashed border-slate-300 rounded-2xl bg-white flex flex-col items-center justify-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:shadow-md">
                <div class="pointer-events-none flex flex-col items-center text-center space-y-3">
                    <div class="p-3 bg-slate-100 rounded-full group-hover:bg-blue-100 text-slate-400 group-hover:text-blue-600 transition-colors duration-300">
                        <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-slate-700 group-hover:text-blue-700 transition-colors">Excel-Dateien hier ablegen</p>
                        <p class="text-sm text-slate-400 mt-1">Unterstützt .xlsx Dateien</p>
                    </div>
                </div>
                <input type="file" id="fileElem" multiple accept=".xlsx" class="hidden" onchange="handleFiles(this.files)">
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-4 gap-4">
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <div class="bg-emerald-100 p-1.5 rounded text-emerald-700">
                    <i data-lucide="table-2" class="w-4 h-4"></i>
                </div>
                Extrahierte Daten
                <span id="record-count-badge" class="text-xs font-normal bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full hidden">0</span>
            </h2>

            <div class="flex gap-2">
                <button onclick="exportToExcel()" id="btn-export" class="opacity-50 cursor-not-allowed px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-sm shadow-green-200 transition-all flex items-center gap-2" disabled>
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Exportieren (.xlsx)
                </button>
                <button onclick="clearTable()" class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg border border-red-200 transition-colors flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Leeren
                </button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
            <div class="overflow-x-auto custom-scrollbar">
                <table id="data-table" class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200 sticky top-0">
                        <tr>
                            <th class="px-6 py-4 font-semibold whitespace-nowrap">Datei</th>
                            <th class="px-6 py-4 font-semibold">Auftrags-Nr.</th>
                            <th class="px-6 py-4 font-semibold">Anlage</th>
                            <th class="px-6 py-4 font-semibold">Einsatzort</th>
                            <th class="px-6 py-4 font-semibold">Datum</th>
                            <th class="px-6 py-4 font-semibold" title="Fachmonteurstunde">
                                Fach. (M)
                                <span class="block text-[10px] normal-case opacity-70 font-normal">Links v. Label</span>
                            </th>
                            <th class="px-6 py-4 font-semibold text-right">Auftragssumme</th>
                            <th class="px-6 py-4 font-semibold min-w-[250px]">
                                Bemerkung
                                <span class="block text-[10px] normal-case opacity-70 font-normal">Unter d. Label</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        <!-- Rows inserted via JS -->
                        <tr id="empty-state">
                            <td colspan="8" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center justify-center text-slate-300">
                                    <i data-lucide="search-x" class="w-12 h-12 mb-3 opacity-50"></i>
                                    <span class="text-base font-medium">Keine Daten vorhanden</span>
                                    <span class="text-sm">Dateien oben in den Bereich ziehen</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer / Totals -->
            <div class="bg-slate-50 border-t border-slate-200 p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-xs text-slate-500">
                        Erfolgreich verarbeitet: <span id="count-display" class="font-bold text-slate-800">0</span> Dateien
                    </div>

                    <div class="flex items-center bg-white px-5 py-3 rounded-xl border border-slate-200 shadow-sm gap-4">
                        <div class="text-right">
                            <p class="text-[10px] uppercase font-bold tracking-wider text-slate-400 mb-0.5">Gesamtsumme</p>
                            <h3 class="text-2xl font-bold text-slate-800 tabular-nums" id="total-display">0,00 €</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i data-lucide="euro" class="w-5 h-5"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
        </div>

    </div>

    <!-- Notification Area (Shared) -->
    <div id="notification-area" class="fixed bottom-6 right-6 space-y-3 pointer-events-none z-50 flex flex-col items-end"></div>

    <script>
        // Tab Switching Logic
        function switchTab(tabName) {
            const tool1Content = document.getElementById('tool1-content');
            const tool2Content = document.getElementById('tool2-content');
            const tab1 = document.getElementById('tab-tool1');
            const tab2 = document.getElementById('tab-tool2');

            if (tabName === 'tool1') {
                tool1Content.classList.remove('hidden');
                tool2Content.classList.add('hidden');

                tab1.classList.add('border-indigo-500', 'text-gray-900');
                tab1.classList.remove('border-transparent', 'text-gray-500');

                tab2.classList.add('border-transparent', 'text-gray-500');
                tab2.classList.remove('border-indigo-500', 'text-gray-900');
            } else {
                tool1Content.classList.add('hidden');
                tool2Content.classList.remove('hidden');

                tab2.classList.add('border-indigo-500', 'text-gray-900');
                tab2.classList.remove('border-transparent', 'text-gray-500');

                tab1.classList.add('border-transparent', 'text-gray-500');
                tab1.classList.remove('border-indigo-500', 'text-gray-900');
            }
        }

        // --- Tool 1 Logic (Wrapped) ---
        (function() {
            // --- Constants & State ---
            const DEFAULT_TARGETS = [
                "01.01.0010", "01.01.0020", "01.01.0030", "01.01.0040", "01.01.0050",
                "01.01.0060", "01.01.0070", "01.01.0080", "01.01.0090", "01.01.0100",
                "01.01.0110", "01.01.0120", "01.01.0130", "01.01.0140", "01.01.0150",
                "01.01.0160", "01.01.0170", "01.01.0180", "01.01.0190", "01.01.0200",
                "01.01.0210", "01.01.0220", "01.01.0230", "01.01.0240", "01.01.0250",
                "01.01.0260", "01.01.0270", "01.01.0280", "01.01.0290", "01.01.0300",
                "01.01.0310", "01.01.0320", "01.01.0330", "01.01.0340", "01.02.0010",
                "01.02.0020", "01.02.0030", "01.02.0040", "01.02.0050", "01.02.0060",
                "01.02.0070", "01.02.0080", "01.03.0010", "01.03.0020", "01.03.0030",
                "01.03.0040", "01.03.0050", "01.03.0060", "01.03.0070", "01.03.0080",
                "01.03.0090", "01.03.0100", "01.03.0110", "01.04.0010", "01.04.0020",
                "01.04.0030", "01.04.0040", "01.04.0050", "01.04.0060", "01.04.0070",
                "01.04.0080", "01.04.0090", "01.05.0010", "01.05.0020", "01.05.0030",
                "01.05.0040", "01.06.0010", "01.06.0020", "01.06.0030", "01.06.0040",
                "01.06.0050"
            ];

            let currentTargets = [];
            let currentResults = []; // For CSV export
            let extractedHeader = {}; // For CSV export

            // --- Elements ---
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const feedback = document.getElementById('feedback');
            const resultsContainer = document.getElementById('resultsContainer');
            const targetValuesArea = document.getElementById('targetValuesArea');
            const updateTargetsBtn = document.getElementById('updateTargets');
            const toggleConfigBtn = document.getElementById('toggleConfigBtn');
            const configPanel = document.getElementById('configPanel');
            const configIcon = document.getElementById('configIcon');

            // --- Initialization ---
            function init() {
                resetDefaultTargets();
                updateTargets(); // Load defaults into memory

                // Listeners
                updateTargetsBtn.addEventListener('click', () => {
                    updateTargets();
                    showFeedback('Targets updated successfully!', 'success');
                });

                toggleConfigBtn.addEventListener('click', () => {
                    configPanel.classList.toggle('hidden');
                    configIcon.classList.toggle('ph-caret-up');
                    configIcon.classList.toggle('ph-caret-down');
                });

                fileInput.addEventListener('change', handleFileSelect);

                // Drag effects
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        dropArea.querySelector('div').classList.add('drag-active');
                    }, false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        dropArea.querySelector('div').classList.remove('drag-active');
                    }, false);
                });
                dropArea.addEventListener('drop', handleDrop, false);
            }

            // --- Core Logic ---

            function resetDefaultTargets() {
                targetValuesArea.value = DEFAULT_TARGETS.join('\n');
            }

            function updateTargets() {
                currentTargets = targetValuesArea.value
                    .split('\n')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
            }

            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) processFile(file);
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                if (file) processFile(file);
            }

            function showFeedback(msg, type) {
                feedback.className = `rounded-lg p-4 text-center text-sm font-medium mb-6 ${
                    type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' :
                    type === 'loading' ? 'bg-blue-50 text-blue-700 border border-blue-200 flex justify-center items-center gap-2' :
                    'bg-green-50 text-green-700 border border-green-200'
                }`;

                if(type === 'loading') {
                    feedback.innerHTML = `<div class="loader"></div> ${msg}`;
                } else {
                    feedback.textContent = msg;
                }
                feedback.classList.remove('hidden');
            }

            function processFile(file) {
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    showFeedback('Invalid file type. Please upload an Excel (.xlsx) file.', 'error');
                    return;
                }

                showFeedback(`Processing ${file.name}...`, 'loading');
                resultsContainer.classList.add('hidden');

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        if (workbook.SheetNames.length === 0) throw new Error("No sheets found.");
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];

                        // KEY FIX: raw: false ensures we get the formatted string (e.g., "01.01.2020")
                        // instead of the Excel serial number (e.g., 43831).
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });

                        analyzeData(rows);
                    } catch (err) {
                        console.error(err);
                        showFeedback(`Error reading file: ${err.message}`, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function analyzeData(rows) {
                // 1. Extract Headers
                const datum = findValue(rows, "Nr.:");
                const auftrag = findValue(rows, "Auftrag Nr.:");
                const inv = findValue(rows, "INV:");
                const anlage = findValue(rows, "Anlage:");
                const ort = findOrtValue(rows); // Special logic for 2nd occurrence

                extractedHeader = {
                    datum: datum || "Not Found",
                    auftrag: auftrag || "Not Found",
                    anlage: (inv || anlage) ? `${inv || ''}_${anlage || ''}` : "N/A",
                    ort: ort || "Not Found"
                };

                // Update Header UI
                document.getElementById('outDatum').textContent = extractedHeader.datum;
                document.getElementById('outAuftrag').textContent = extractedHeader.auftrag;
                document.getElementById('outAnlage').textContent = extractedHeader.anlage;
                document.getElementById('outOrt').textContent = extractedHeader.ort;

                // 2. Count Occurrences
                const counts = new Map();
                let totalMatches = 0;
                let debugRows = [];

                // Initialize Map with 0 for all targets
                currentTargets.forEach(t => counts.set(t, 0));

                // Iterate Rows
                rows.forEach((row, idx) => {
                    // Column A is index 0. Ensure it's a string.
                    const cellVal = String(row[0] || "").trim();

                    if (!cellVal) return;

                    // Debug first 5 rows
                    if (debugRows.length < 5) debugRows.push(cellVal);

                    // Check against targets
                    currentTargets.forEach(target => {
                        if (cellVal.includes(target)) {
                            counts.set(target, counts.get(target) + 1);
                            totalMatches++;
                        }
                    });
                });

                // 3. Render Table
                renderTable(counts, totalMatches, rows.length);

                // 4. Show Debug if no matches
                const debugArea = document.getElementById('debugArea');
                if (totalMatches === 0) {
                    debugArea.classList.remove('hidden');
                    document.getElementById('debugList').innerHTML = debugRows.map(v => `<li>${v}</li>`).join('');
                } else {
                    debugArea.classList.add('hidden');
                }

                showFeedback('Analysis complete.', 'success');
                resultsContainer.classList.remove('hidden');
            }

            // --- Helper Functions ---

            // Finds a label (searchStr) and returns the NEXT non-empty cell in that row.
            function findValue(rows, searchStr) {
                for (let r = 0; r < rows.length; r++) {
                    const row = rows[r];
                    for (let c = 0; c < row.length; c++) {
                        const cell = String(row[c] || "");
                        if (cell.includes(searchStr)) {
                            // Found label, scan rest of row for value
                            for (let k = c + 1; k < row.length; k++) {
                                const val = String(row[k] || "").trim();
                                if (val) return val;
                            }
                        }
                    }
                }
                return null;
            }

            // Specific requirement: Find the SECOND occurrence of "Ort:"
            function findOrtValue(rows) {
                let occurrences = 0;
                for (let r = 0; r < rows.length; r++) {
                    const row = rows[r];
                    for (let c = 0; c < row.length; c++) {
                        const cell = String(row[c] || "");
                        if (cell.includes("Ort:")) {
                            occurrences++;
                            if (occurrences === 2) {
                                // Found 2nd occurrence, scan rest of row
                                for (let k = c + 1; k < row.length; k++) {
                                    const val = String(row[k] || "").trim();
                                    if (val) return val;
                                }
                            }
                        }
                    }
                }
                return null;
            }

            function renderTable(countsMap, totalMatches, rowCount) {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                document.getElementById('matchSummary').textContent =
                    `Found ${totalMatches} matches across ${rowCount} processed rows.`;

                // Filter only positive counts if you want to hide zeros,
                // OR show all to confirm what was checked.
                // Logic: Show all non-zero, plus sort them.
                const sorted = Array.from(countsMap.entries())
                    .filter(([_, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1]); // Sort by count DESC

                if (sorted.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500 italic">No targets found in Column A</td></tr>`;
                    currentResults = [];
                    return;
                }

                currentResults = sorted; // Save for CSV

                sorted.forEach(([target, count]) => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50 transition-colors";
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-indigo-700 font-medium">${target}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-bold">${count}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Found</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // --- Export Features ---

            // Made global within this scope so the buttons can call them.
            // In the HTML above, onclick="copyToClipboard('outDatum')" refers to global scope.
            // We need to attach these to window for the inline onclicks to work.
            window.copyToClipboard = function(elementId) {
                const text = document.getElementById(elementId).textContent;
                if (text && text !== '-' && text !== 'Not Found') {
                    navigator.clipboard.writeText(text).then(() => {
                        showFeedback(`Copied "${text}" to clipboard!`, 'success');
                    });
                }
            };

            window.copyTableToClipboard = function() {
                if (!currentResults.length) return;
                let text = "Target Value\\tCount\\n";
                currentResults.forEach(r => text += `${r[0]}\\t${r[1]}\\n`);
                navigator.clipboard.writeText(text).then(() => showFeedback("Table copied to clipboard!", 'success'));
            };

            window.downloadCSV = function() {
                if (!currentResults.length) return;

                // Create CSV Content
                // Add Header Info at top
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += `Protokoll,${extractedHeader.datum}\\n`;
                csvContent += `Auftrag,${extractedHeader.auftrag}\\n`;
                csvContent += `Anlage,${extractedHeader.anlage}\\n`;
                csvContent += `Ort,${extractedHeader.ort}\\n\\n`;

                // Add Table Data
                csvContent += "Target Value,Count\\n";
                currentResults.forEach(row => {
                    csvContent += `${row[0]},${row[1]}\\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `analysis_results_${extractedHeader.auftrag || 'export'}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Also need global access to resetDefaultTargets if used in onclick
             window.resetDefaultTargets = resetDefaultTargets;

            // Run init
            init();
        })();

        // --- Tool 2 Logic (Wrapped) ---
        (function() {
            // Initialize Icons
            lucide.createIcons();

            // --- Global State ---
            let state = {
                totalSum: 0,
                validRecords: 0,
                extractedData: [] // Store data for export
            };

            const UI = {
                tableBody: document.getElementById('table-body'),
                emptyState: document.getElementById('empty-state'),
                dropArea: document.getElementById('drop-area'),
                totalDisplay: document.getElementById('total-display'),
                countDisplay: document.getElementById('count-display'),
                badgeCount: document.getElementById('record-count-badge'),
                exportBtn: document.getElementById('btn-export')
            };

            // --- Drag and Drop Setup ---
            const events = ['dragenter', 'dragover', 'dragleave', 'drop'];

            events.forEach(evt => {
                UI.dropArea.addEventListener(evt, preventDefaults, false);
                document.body.addEventListener(evt, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(evt => {
                UI.dropArea.addEventListener(evt, () => UI.dropArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(evt => {
                UI.dropArea.addEventListener(evt, () => UI.dropArea.classList.remove('dragover'), false);
            });

            UI.dropArea.addEventListener('drop', handleDrop, false);
            UI.dropArea.addEventListener('click', () => document.getElementById('fileElem').click());

            function handleDrop(e) {
                const dt = e.dataTransfer;
                handleFiles(dt.files);
            }

            // Made global for onchange="handleFiles(this.files)"
            window.handleFiles = function(files) {
                const filesArray = [...files];
                const excelFiles = filesArray.filter(file => file.name.match(/\.xlsx$|\.xls$/));

                if (excelFiles.length === 0 && filesArray.length > 0) {
                    showNotification('Nur Excel-Dateien (.xlsx, .xls) erlaubt.', 'error');
                    return;
                }

                // Process files
                excelFiles.forEach(readExcel);

                // Reset input so same file can be selected again if needed
                document.getElementById('fileElem').value = '';
            };

            // --- Core Processing Logic ---

            function readExcel(file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Assume first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Convert to Array of Arrays (header: 1 gives raw array)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                        processData(jsonData, file.name);
                        showNotification(`Dateigelesen: ${file.name}`, 'success');

                    } catch (err) {
                        console.error(err);
                        showNotification(`Fehler bei ${file.name}`, 'error');
                    }
                };

                reader.readAsArrayBuffer(file);
            }

            // Helper: Clean string for comparison
            const cleanStr = (val) => String(val || '').trim().toLowerCase();

            function parseExcelDate(value) {
                if (!value) return "";
                // Excel numeric date
                if (typeof value === 'number') {
                    const dateObj = XLSX.SSF.parse_date_code(value);
                    if(dateObj) {
                        const day = String(dateObj.d).padStart(2, '0');
                        const month = String(dateObj.m).padStart(2, '0');
                        return `${day}.${month}.${dateObj.y}`;
                    }
                }
                // If it's already a string, assume it's fine but maybe trim it
                return String(value).trim();
            }

            function parseCurrency(value) {
                if (!value) return 0;
                if (typeof value === 'number') return value;

                // Remove currency symbols and whitespace
                // Handles: "1.000,00 €", "1,000.00", "1000"
                let clean = String(value).replace(/[^\d.,-]/g, '').trim();

                // German format detection (comma is decimal separator if it appears last or only separator)
                // 1.000,00 -> matches German
                // 1,000.00 -> matches US

                if (clean.indexOf(',') > -1 && clean.indexOf('.') > -1) {
                    if (clean.lastIndexOf(',') > clean.lastIndexOf('.')) {
                        // German: 1.234,56
                        clean = clean.replace(/\./g, '').replace(',', '.');
                    } else {
                        // US: 1,234.56
                        clean = clean.replace(/,/g, '');
                    }
                } else if (clean.indexOf(',') > -1) {
                    // Assume German decimal only: 50,00
                    clean = clean.replace(',', '.');
                }

                const num = parseFloat(clean);
                return isNaN(num) ? 0 : num;
            }

            /**
             * Flexible Finder
             * logicType:
             * 'next_col': cell to the right
             * 'prev_col': cell to the left
             * 'next_row': cell below
             */
            function findValueInMatrix(matrix, searchLabel, logicType) {
                const label = cleanStr(searchLabel);

                for (let r = 0; r < matrix.length; r++) {
                    const row = matrix[r];
                    if (!row) continue;

                    for (let c = 0; c < row.length; c++) {
                        const cellValue = cleanStr(row[c]);

                        // Flexible match check
                        if (cellValue.includes(label) && cellValue.length > 0) {

                            // 1. Next Column (Scan right up to 5 cells for non-empty)
                            if (logicType === 'next_col') {
                                for (let offset = 1; offset <= 5; offset++) {
                                    let val = row[c + offset];
                                    if (val !== undefined && val !== null && String(val).trim() !== "") {
                                        return val;
                                    }
                                }
                                return "";
                            }

                            // 2. Previous Column (Immediate left)
                            if (logicType === 'prev_col') {
                                let val = row[c - 1];
                                return (val !== undefined && val !== null && String(val).trim() !== "") ? val : "";
                            }

                            // 3. Next Row (Below)
                            if (logicType === 'next_row') {
                                if (matrix[r + 1]) {
                                    let val = matrix[r + 1][c];
                                    return (val !== undefined && val !== null && String(val).trim() !== "") ? val : "";
                                }
                                return "";
                            }
                        }
                    }
                }
                return "";
            }

            function processData(matrix, fileName) {
                // Hide empty state
                if (UI.emptyState) UI.emptyState.style.display = 'none';

                // Extraction Configuration
                // Adjust search terms here if Excel templates change
                const rawDatum = findValueInMatrix(matrix, "Datum", 'next_col');
                const datum = parseExcelDate(rawDatum) || rawDatum; // Try parse, fallback to raw

                const auftragsNr = findValueInMatrix(matrix, "Auftrags-Nr.", 'next_col');
                const anlage = findValueInMatrix(matrix, "Anlage", 'next_col');
                const einsatzort = findValueInMatrix(matrix, "Einsatzort", 'next_col');

                // Logic: Sometimes value is BEFORE label like "4.5 Fachmonteurstunde"
                const fachmonteur = findValueInMatrix(matrix, "Fachmonteurstunde", 'prev_col');

                const bemerkung = findValueInMatrix(matrix, "Bemerkung", 'next_row');

                const rawSum = findValueInMatrix(matrix, "Auftragssumme", 'next_col');
                const parsedSum = rawSum !== "" ? parseCurrency(rawSum) : 0;

                // Prevent adding empty rows if essentially no data found
                if (!datum && !auftragsNr && !parsedSum) {
                    showNotification(`Keine relevanten Daten in ${fileName} gefunden`, 'error');
                    return;
                }

                // Update Global State
                if (parsedSum > 0) {
                    state.totalSum += parsedSum;
                    state.validRecords++;
                }

                // Save for Export
                const record = {
                    fileName,
                    datum,
                    auftragsNr,
                    anlage,
                    einsatzort,
                    fachmonteur,
                    sumRaw: parsedSum,
                    bemerkung
                };
                state.extractedData.push(record);

                updateUI();
                renderRow(record);
            }

            function renderRow(data) {
                const tr = document.createElement('tr');
                const hasBemerkung = data.bemerkung && String(data.bemerkung).trim().length > 0;
                const baseBg = hasBemerkung ? "bg-orange-50" : "bg-white";
                tr.className = `${baseBg} hover:bg-blue-50 transition-colors fade-in group`;

                // Format Currency for Display
                const sumDisplay = (data.sumRaw > 0)
                    ? data.sumRaw.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })
                    : '-';

                // Safe HTML injection helper
                const safe = (txt) => txt ? String(txt) : '';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-xs font-medium text-slate-400 border-b border-slate-100">
                        <div class="flex items-center gap-2 max-w-[150px]">
                            <i data-lucide="file" class="w-3 h-3 flex-shrink-0"></i>
                            <span class="truncate" title="${safe(data.fileName)}">${safe(data.fileName)}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-700 font-mono text-xs bg-slate-50 rounded">${safe(data.auftragsNr)}</td>
                    <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-xs max-w-[150px] truncate" title="${safe(data.anlage)}">${safe(data.anlage)}</td>
                    <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-xs max-w-[150px] truncate" title="${safe(data.einsatzort)}">${safe(data.einsatzort)}</td>
                    <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-700">${safe(data.datum)}</td>
                    <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-center">${safe(data.fachmonteur)}</td>
                    <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-right font-mono text-slate-800 font-semibold">${sumDisplay}</td>
                    <td class="px-6 py-4 border-b border-slate-100 text-slate-500 text-xs min-w-[200px] leading-relaxed">${safe(data.bemerkung)}</td>
                `;

                UI.tableBody.appendChild(tr);
                lucide.createIcons(); // Refresh icons for new row
            }

            function updateUI() {
                UI.totalDisplay.textContent = state.totalSum.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
                UI.countDisplay.textContent = state.validRecords;
                UI.badgeCount.textContent = state.validRecords;

                if (state.validRecords > 0) {
                    UI.badgeCount.classList.remove('hidden');
                    UI.exportBtn.disabled = false;
                    UI.exportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // Made global for onclick="clearTable()"
            window.clearTable = function() {
                UI.tableBody.innerHTML = '';
                UI.tableBody.appendChild(UI.emptyState);
                UI.emptyState.style.display = 'table-row';

                // Reset State
                state.totalSum = 0;
                state.validRecords = 0;
                state.extractedData = [];

                // Reset UI
                UI.badgeCount.classList.add('hidden');
                UI.exportBtn.disabled = true;
                UI.exportBtn.classList.add('opacity-50', 'cursor-not-allowed');

                updateUI();
                showNotification('Tabelle geleert', 'success');
            };

            // Made global for onclick="exportToExcel()"
            window.exportToExcel = function() {
                if (state.extractedData.length === 0) return;

                // Prepare data for export (clean headers)
                const wsData = state.extractedData.map(item => ({
                    "Dateiname": item.fileName,
                    "Auftragsnummer": item.auftragsNr,
                    "Anlage": item.anlage,
                    "Einsatzort": item.einsatzort,
                    "Datum": item.datum,
                    "Fachmonteurstunden": item.fachmonteur,
                    "Auftragssumme": item.sumRaw, // Keep as number for Excel math
                    "Bemerkung": item.bemerkung
                }));

                const ws = XLSX.utils.json_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Exportierte Daten");

                // Generate filename with timestamp
                const dateStr = new Date().toISOString().slice(0,10);
                XLSX.writeFile(wb, `Export_Daten_${dateStr}.xlsx`);

                showNotification('Excel-Datei heruntergeladen!', 'success');
            };

            // --- Notification System ---
            function showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                const styles = type === 'error'
                    ? 'bg-red-50 text-red-600 border-red-200'
                    : 'bg-emerald-50 text-emerald-600 border-emerald-200';

                const icon = type === 'error' ? 'alert-circle' : 'check-circle-2';

                notif.className = `${styles} border px-4 py-3 rounded-lg shadow-lg transform transition-all duration-500 translate-y-10 opacity-0 flex items-center gap-3 text-sm font-medium min-w-[300px]`;
                notif.innerHTML = `
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                    <span>${message}</span>
                `;

                document.getElementById('notification-area').appendChild(notif);
                lucide.createIcons();

                // Animate In
                requestAnimationFrame(() => notif.classList.remove('translate-y-10', 'opacity-0'));

                // Remove after 3s
                setTimeout(() => {
                    notif.classList.add('translate-y-4', 'opacity-0');
                    setTimeout(() => notif.remove(), 500);
                }, 3000);
            }
        })();

    </script>
</body>
</html>