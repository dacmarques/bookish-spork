<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Excel Data Extractor</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Drag Animation */
        .dragover {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
            border-style: solid;
            transform: scale(1.005);
        }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-200">
                        <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 tracking-tight">Excel Extraktor Pro</h1>
                        <p class="text-slate-500 text-xs font-medium">Intelligente Stichwortsuche & Analyse</p>
                    </div>
                </div>
                <div class="text-right hidden sm:block">
                    <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">Version 2.0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">

        <!-- Upload Section -->
        <div class="mb-8">
            <div id="drop-area" class="group relative w-full h-48 border-2 border-dashed border-slate-300 rounded-2xl bg-white flex flex-col items-center justify-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:shadow-md">
                <div class="pointer-events-none flex flex-col items-center text-center space-y-3">
                    <div class="p-3 bg-slate-100 rounded-full group-hover:bg-blue-100 text-slate-400 group-hover:text-blue-600 transition-colors duration-300">
                        <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-slate-700 group-hover:text-blue-700 transition-colors">Excel-Dateien hier ablegen</p>
                        <p class="text-sm text-slate-400 mt-1">Unterstützt .xlsx Dateien</p>
                    </div>
                </div>
                <input type="file" id="fileElem" multiple accept=".xlsx" class="hidden" onchange="handleFiles(this.files)">
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-4 gap-4">
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <div class="bg-emerald-100 p-1.5 rounded text-emerald-700">
                    <i data-lucide="table-2" class="w-4 h-4"></i>
                </div>
                Extrahierte Daten
                <span id="record-count-badge" class="text-xs font-normal bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full hidden">0</span>
            </h2>

            <div class="flex gap-2">
                <button onclick="exportToExcel()" id="btn-export" class="opacity-50 cursor-not-allowed px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-sm shadow-green-200 transition-all flex items-center gap-2" disabled>
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Exportieren (.xlsx)
                </button>
                <button onclick="clearTable()" class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg border border-red-200 transition-colors flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Leeren
                </button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
            <div class="overflow-x-auto custom-scrollbar">
                <table id="data-table" class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200 sticky top-0">
                        <tr>
                            <th class="px-6 py-4 font-semibold whitespace-nowrap">Datei</th>
                            <th class="px-6 py-4 font-semibold">Auftrags-Nr.</th>
                            <th class="px-6 py-4 font-semibold">Anlage</th>
                            <th class="px-6 py-4 font-semibold">Einsatzort</th>
                            <th class="px-6 py-4 font-semibold">Datum</th>
                            <th class="px-6 py-4 font-semibold" title="Fachmonteurstunde">
                                Fach. (M)
                                <span class="block text-[10px] normal-case opacity-70 font-normal">Links v. Label</span>
                            </th>
                            <th class="px-6 py-4 font-semibold text-right">Auftragssumme</th>
                            <th class="px-6 py-4 font-semibold min-w-[250px]">
                                Bemerkung
                                <span class="block text-[10px] normal-case opacity-70 font-normal">Unter d. Label</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        <!-- Rows inserted via JS -->
                        <tr id="empty-state">
                            <td colspan="8" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center justify-center text-slate-300">
                                    <i data-lucide="search-x" class="w-12 h-12 mb-3 opacity-50"></i>
                                    <span class="text-base font-medium">Keine Daten vorhanden</span>
                                    <span class="text-sm">Dateien oben in den Bereich ziehen</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer / Totals -->
            <div class="bg-slate-50 border-t border-slate-200 p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-xs text-slate-500">
                        Erfolgreich verarbeitet: <span id="count-display" class="font-bold text-slate-800">0</span> Dateien
                    </div>

                    <div class="flex items-center bg-white px-5 py-3 rounded-xl border border-slate-200 shadow-sm gap-4">
                        <div class="text-right">
                            <p class="text-[10px] uppercase font-bold tracking-wider text-slate-400 mb-0.5">Gesamtsumme</p>
                            <h3 class="text-2xl font-bold text-slate-800 tabular-nums" id="total-display">0,00 €</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i data-lucide="euro" class="w-5 h-5"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Notifications Toast -->
    <div id="notification-area" class="fixed bottom-6 right-6 space-y-3 pointer-events-none z-50 flex flex-col items-end"></div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- Global State ---
        let state = {
            totalSum: 0,
            validRecords: 0,
            extractedData: [] // Store data for export
        };

        const UI = {
            tableBody: document.getElementById('table-body'),
            emptyState: document.getElementById('empty-state'),
            dropArea: document.getElementById('drop-area'),
            totalDisplay: document.getElementById('total-display'),
            countDisplay: document.getElementById('count-display'),
            badgeCount: document.getElementById('record-count-badge'),
            exportBtn: document.getElementById('btn-export')
        };

        // --- Drag and Drop Setup ---
        const events = ['dragenter', 'dragover', 'dragleave', 'drop'];

        events.forEach(evt => {
            UI.dropArea.addEventListener(evt, preventDefaults, false);
            document.body.addEventListener(evt, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(evt => {
            UI.dropArea.addEventListener(evt, () => UI.dropArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(evt => {
            UI.dropArea.addEventListener(evt, () => UI.dropArea.classList.remove('dragover'), false);
        });

        UI.dropArea.addEventListener('drop', handleDrop, false);
        UI.dropArea.addEventListener('click', () => document.getElementById('fileElem').click());

        function handleDrop(e) {
            const dt = e.dataTransfer;
            handleFiles(dt.files);
        }

        function handleFiles(files) {
            const filesArray = [...files];
            const excelFiles = filesArray.filter(file => file.name.match(/\.xlsx$|\.xls$/));

            if (excelFiles.length === 0 && filesArray.length > 0) {
                showNotification('Nur Excel-Dateien (.xlsx, .xls) erlaubt.', 'error');
                return;
            }

            // Process files
            excelFiles.forEach(readExcel);

            // Reset input so same file can be selected again if needed
            document.getElementById('fileElem').value = '';
        }

        // --- Core Processing Logic ---

        function readExcel(file) {
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Assume first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to Array of Arrays (header: 1 gives raw array)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                    processData(jsonData, file.name);
                    showNotification(`Dateigelesen: ${file.name}`, 'success');

                } catch (err) {
                    console.error(err);
                    showNotification(`Fehler bei ${file.name}`, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Helper: Clean string for comparison
        const cleanStr = (val) => String(val || '').trim().toLowerCase();

        function parseExcelDate(value) {
            if (!value) return "";
            // Excel numeric date
            if (typeof value === 'number') {
                const dateObj = XLSX.SSF.parse_date_code(value);
                if(dateObj) {
                    const day = String(dateObj.d).padStart(2, '0');
                    const month = String(dateObj.m).padStart(2, '0');
                    return `${day}.${month}.${dateObj.y}`;
                }
            }
            // If it's already a string, assume it's fine but maybe trim it
            return String(value).trim();
        }

        function parseCurrency(value) {
            if (!value) return 0;
            if (typeof value === 'number') return value;

            // Remove currency symbols and whitespace
            // Handles: "1.000,00 €", "1,000.00", "1000"
            let clean = String(value).replace(/[^\d.,-]/g, '').trim();

            // German format detection (comma is decimal separator if it appears last or only separator)
            // 1.000,00 -> matches German
            // 1,000.00 -> matches US

            if (clean.indexOf(',') > -1 && clean.indexOf('.') > -1) {
                if (clean.lastIndexOf(',') > clean.lastIndexOf('.')) {
                    // German: 1.234,56
                    clean = clean.replace(/\./g, '').replace(',', '.');
                } else {
                    // US: 1,234.56
                    clean = clean.replace(/,/g, '');
                }
            } else if (clean.indexOf(',') > -1) {
                // Assume German decimal only: 50,00
                clean = clean.replace(',', '.');
            }

            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }

        /**
         * Flexible Finder
         * logicType:
         * 'next_col': cell to the right
         * 'prev_col': cell to the left
         * 'next_row': cell below
         */
        function findValueInMatrix(matrix, searchLabel, logicType) {
            const label = cleanStr(searchLabel);

            for (let r = 0; r < matrix.length; r++) {
                const row = matrix[r];
                if (!row) continue;

                for (let c = 0; c < row.length; c++) {
                    const cellValue = cleanStr(row[c]);

                    // Flexible match check
                    if (cellValue.includes(label) && cellValue.length > 0) {

                        // 1. Next Column (Scan right up to 5 cells for non-empty)
                        if (logicType === 'next_col') {
                            for (let offset = 1; offset <= 5; offset++) {
                                let val = row[c + offset];
                                if (val !== undefined && val !== null && String(val).trim() !== "") {
                                    return val;
                                }
                            }
                            return "";
                        }

                        // 2. Previous Column (Immediate left)
                        if (logicType === 'prev_col') {
                            let val = row[c - 1];
                            return (val !== undefined && val !== null && String(val).trim() !== "") ? val : "";
                        }

                        // 3. Next Row (Below)
                        if (logicType === 'next_row') {
                            if (matrix[r + 1]) {
                                let val = matrix[r + 1][c];
                                return (val !== undefined && val !== null && String(val).trim() !== "") ? val : "";
                            }
                            return "";
                        }
                    }
                }
            }
            return "";
        }

        function processData(matrix, fileName) {
            // Hide empty state
            if (UI.emptyState) UI.emptyState.style.display = 'none';

            // Extraction Configuration
            // Adjust search terms here if Excel templates change
            const rawDatum = findValueInMatrix(matrix, "Datum", 'next_col');
            const datum = parseExcelDate(rawDatum) || rawDatum; // Try parse, fallback to raw

            const auftragsNr = findValueInMatrix(matrix, "Auftrags-Nr.", 'next_col');
            const anlage = findValueInMatrix(matrix, "Anlage", 'next_col');
            const einsatzort = findValueInMatrix(matrix, "Einsatzort", 'next_col');

            // Logic: Sometimes value is BEFORE label like "4.5 Fachmonteurstunde"
            const fachmonteur = findValueInMatrix(matrix, "Fachmonteurstunde", 'prev_col');

            const bemerkung = findValueInMatrix(matrix, "Bemerkung", 'next_row');

            const rawSum = findValueInMatrix(matrix, "Auftragssumme", 'next_col');
            const parsedSum = rawSum !== "" ? parseCurrency(rawSum) : 0;

            // Prevent adding empty rows if essentially no data found
            if (!datum && !auftragsNr && !parsedSum) {
                showNotification(`Keine relevanten Daten in ${fileName} gefunden`, 'error');
                return;
            }

            // Update Global State
            if (parsedSum > 0) {
                state.totalSum += parsedSum;
                state.validRecords++;
            }

            // Save for Export
            const record = {
                fileName,
                datum,
                auftragsNr,
                anlage,
                einsatzort,
                fachmonteur,
                sumRaw: parsedSum,
                bemerkung
            };
            state.extractedData.push(record);

            updateUI();
            renderRow(record);
        }

        function renderRow(data) {
            const tr = document.createElement('tr');
            const hasBemerkung = data.bemerkung && String(data.bemerkung).trim().length > 0;
            const baseBg = hasBemerkung ? "bg-orange-50" : "bg-white";
            tr.className = `${baseBg} hover:bg-blue-50 transition-colors fade-in group`;

            // Format Currency for Display
            const sumDisplay = (data.sumRaw > 0)
                ? data.sumRaw.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' })
                : '-';

            // Safe HTML injection helper
            const safe = (txt) => txt ? String(txt) : '';

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-xs font-medium text-slate-400 border-b border-slate-100">
                    <div class="flex items-center gap-2 max-w-[150px]">
                        <i data-lucide="file" class="w-3 h-3 flex-shrink-0"></i>
                        <span class="truncate" title="${safe(data.fileName)}">${safe(data.fileName)}</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-700 font-mono text-xs bg-slate-50 rounded">${safe(data.auftragsNr)}</td>
                <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-xs max-w-[150px] truncate" title="${safe(data.anlage)}">${safe(data.anlage)}</td>
                <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-xs max-w-[150px] truncate" title="${safe(data.einsatzort)}">${safe(data.einsatzort)}</td>
                <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-700">${safe(data.datum)}</td>
                <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-slate-600 text-center">${safe(data.fachmonteur)}</td>
                <td class="px-6 py-4 whitespace-nowrap border-b border-slate-100 text-right font-mono text-slate-800 font-semibold">${sumDisplay}</td>
                <td class="px-6 py-4 border-b border-slate-100 text-slate-500 text-xs min-w-[200px] leading-relaxed">${safe(data.bemerkung)}</td>
            `;

            UI.tableBody.appendChild(tr);
            lucide.createIcons(); // Refresh icons for new row
        }

        function updateUI() {
            UI.totalDisplay.textContent = state.totalSum.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
            UI.countDisplay.textContent = state.validRecords;
            UI.badgeCount.textContent = state.validRecords;

            if (state.validRecords > 0) {
                UI.badgeCount.classList.remove('hidden');
                UI.exportBtn.disabled = false;
                UI.exportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function clearTable() {
            UI.tableBody.innerHTML = '';
            UI.tableBody.appendChild(UI.emptyState);
            UI.emptyState.style.display = 'table-row';

            // Reset State
            state.totalSum = 0;
            state.validRecords = 0;
            state.extractedData = [];

            // Reset UI
            UI.badgeCount.classList.add('hidden');
            UI.exportBtn.disabled = true;
            UI.exportBtn.classList.add('opacity-50', 'cursor-not-allowed');

            updateUI();
            showNotification('Tabelle geleert', 'success');
        }

        function exportToExcel() {
            if (state.extractedData.length === 0) return;

            // Prepare data for export (clean headers)
            const wsData = state.extractedData.map(item => ({
                "Dateiname": item.fileName,
                "Auftragsnummer": item.auftragsNr,
                "Anlage": item.anlage,
                "Einsatzort": item.einsatzort,
                "Datum": item.datum,
                "Fachmonteurstunden": item.fachmonteur,
                "Auftragssumme": item.sumRaw, // Keep as number for Excel math
                "Bemerkung": item.bemerkung
            }));

            const ws = XLSX.utils.json_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Exportierte Daten");

            // Generate filename with timestamp
            const dateStr = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `Export_Daten_${dateStr}.xlsx`);

            showNotification('Excel-Datei heruntergeladen!', 'success');
        }

        // --- Notification System ---
        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            const styles = type === 'error'
                ? 'bg-red-50 text-red-600 border-red-200'
                : 'bg-emerald-50 text-emerald-600 border-emerald-200';

            const icon = type === 'error' ? 'alert-circle' : 'check-circle-2';

            notif.className = `${styles} border px-4 py-3 rounded-lg shadow-lg transform transition-all duration-500 translate-y-10 opacity-0 flex items-center gap-3 text-sm font-medium min-w-[300px]`;
            notif.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5"></i>
                <span>${message}</span>
            `;

            document.getElementById('notification-area').appendChild(notif);
            lucide.createIcons();

            // Animate In
            requestAnimationFrame(() => notif.classList.remove('translate-y-10', 'opacity-0'));

            // Remove after 3s
            setTimeout(() => {
                notif.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => notif.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>